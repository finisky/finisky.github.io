<!DOCTYPE html>
<html lang="en">
<head><!-- hexo injector head_begin start --><!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-K4DEGPDYSW"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag("js", new Date()); gtag("config", "G-K4DEGPDYSW"); </script><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">
  <meta name="google-site-verification" content="oFhcvcGsjsTY5AFUaI-ezbn7-bel9NrdUNpeQfwZSwI">
  <meta name="msvalidate.01" content="F8E2F274161B653649F8818FD127CE87">
  <meta name="yandex-verification" content="ff1f79abcbf80d7e">
  <meta name="baidu-site-verification" content="code-nNL5JO7sPl">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"finisky.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="MongoDB sharded cluster is the most complicated architecture. The deployment of sharded cluster in Kubernetes is relatively hard. We will go through the deployment process by MongoDB Ops Manager in th">
<meta property="og:type" content="article">
<meta property="og:title" content="Deploy MongoDB Sharded Cluster by Ops Manager">
<meta property="og:url" content="https://finisky.github.io/2020/12/26/mongodbomcreateshardedcluster.en/index.html">
<meta property="og:site_name" content="Finisky Garden">
<meta property="og:description" content="MongoDB sharded cluster is the most complicated architecture. The deployment of sharded cluster in Kubernetes is relatively hard. We will go through the deployment process by MongoDB Ops Manager in th">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-12-26T14:18:10.000Z">
<meta property="article:modified_time" content="2023-01-24T14:30:12.000Z">
<meta property="article:author" content="finisky">
<meta property="article:tag" content="MongoDB">
<meta property="article:tag" content="MongoDB Ops Manager">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Sharding">
<meta property="article:tag" content="TLS">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://finisky.github.io/2020/12/26/mongodbomcreateshardedcluster.en/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://finisky.github.io/2020/12/26/mongodbomcreateshardedcluster.en/","path":"/2020/12/26/mongodbomcreateshardedcluster.en/","title":"Deploy MongoDB Sharded Cluster by Ops Manager"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Deploy MongoDB Sharded Cluster by Ops Manager | Finisky Garden</title>
  







<link rel="dns-prefetch" href="https://comments.finisky.eu.org">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script type="text/javascript"> function downloadJsAtOnload() { setTimeout(function downloadJs() { var element = document.createElement("script"); element.setAttribute("data-ad-client", "ca-pub-2660281922577700"); element.async = true; element.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"; document.body.appendChild(element); }, 5000); }; if (window.addEventListener) window.addEventListener("load", downloadJsAtOnload, false); else if (window.attachEvent) window.attachEvent("onload", downloadJsAtOnload); else window.onload = downloadJsAtOnload; </script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Finisky Garden" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Finisky Garden</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">NLP, 软件工程, 产品设计</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-nlp"><a href="/tags/NLP/" rel="section"><i class="fa fa-language fa-fw"></i>NLP</a></li><li class="menu-item menu-item-mongodb"><a href="/categories/MongoDB/" rel="section"><i class="fas fa-database fa-fw"></i>MongoDB</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-友链"><a href="/links/" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#create-a-sharded-cluster"><span class="nav-number">1.</span> <span class="nav-text">Create a Sharded Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#initial-deployment"><span class="nav-number">1.1.</span> <span class="nav-text">Initial Deployment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#expose-mongos-service"><span class="nav-number">1.2.</span> <span class="nav-text">Expose mongos Service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create-server-certificates"><span class="nav-number">1.3.</span> <span class="nav-text">Create Server Certificates</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#config-server.cnf"><span class="nav-number">1.3.1.</span> <span class="nav-text">Config server.cnf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#generate-server-certificate"><span class="nav-number">1.3.2.</span> <span class="nav-text">Generate Server Certificate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#copy-to-get-11-server-certificates"><span class="nav-number">1.3.3.</span> <span class="nav-text">Copy to Get 11 Server
Certificates</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create-server-certificate-and-ca-configmap"><span class="nav-number">1.4.</span> <span class="nav-text">Create Server
Certificate and CA ConfigMap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#create-shards-server-certificate-secret"><span class="nav-number">1.4.1.</span> <span class="nav-text">Create Shards Server
Certificate Secret</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#create-config-server-certificate-secret"><span class="nav-number">1.4.2.</span> <span class="nav-text">Create Config Server
Certificate Secret</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#create-mongos-server-certificate-secret"><span class="nav-number">1.4.3.</span> <span class="nav-text">Create Mongos Server
Certificate Secret</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#create-ca-configmap"><span class="nav-number">1.4.4.</span> <span class="nav-text">Create CA ConfigMap</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#enable-tls"><span class="nav-number">1.5.</span> <span class="nav-text">Enable TLS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#set-mongodspershardcount-to-3"><span class="nav-number">1.6.</span> <span class="nav-text">Set mongodsPerShardCount to
3</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#errors-and-solution"><span class="nav-number">2.</span> <span class="nav-text">Errors and Solution</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#invalid-certificates"><span class="nav-number">2.1.</span> <span class="nav-text">Invalid Certificates</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#enable-tls-when-mongodspershardcount-is-3"><span class="nav-number">2.2.</span> <span class="nav-text">Enable TLS when
mongodsPerShardCount is 3</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#delete-sharded-cluster"><span class="nav-number">3.</span> <span class="nav-text">Delete Sharded Cluster</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="finisky"
      src="/images/qrcode.jpg">
  <p class="site-author-name" itemprop="name">扫码关注公众号</p>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">225</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2020/12/26/mongodbomcreateshardedcluster/" rel="bookmark">
        <time class="popular-posts-time">2020-12-26</time>
        <br>
      部署Kubernetes MongoDB Sharded Cluster
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2021/01/19/mongodbhostdiscoveryissue.en/" rel="bookmark">
        <time class="popular-posts-time">2021-01-19</time>
        <br>
      MongoDB Agent Host Discovery Issue
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2021/01/20/mongodbagentmonitoringnotwork.en/" rel="bookmark">
        <time class="popular-posts-time">2021-01-20</time>
        <br>
      MongoDB Agent Monitoring and Backup not Working
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2020/12/19/mongodbomselfsignedcertificates.en/" rel="bookmark">
        <time class="popular-posts-time">2020-12-19</time>
        <br>
      MongoDB Cluster In Kubernetes(4): Openssl Generates Self-signed Certificates
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2020/12/19/mongodbomtlsauth.en/" rel="bookmark">
        <time class="popular-posts-time">2020-12-19</time>
        <br>
      MongoDB Cluster In Kubernetes(5): Enable UserDB TLS and Auth
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/2020/12/26/mongodbomcreateshardedcluster.en/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Deploy MongoDB Sharded Cluster by Ops Manager | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Deploy MongoDB Sharded Cluster by Ops Manager
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-26 22:18:10" itemprop="dateCreated datePublished" datetime="2020-12-26T22:18:10+08:00">2020-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-01-24 22:30:12" itemprop="dateModified" datetime="2023-01-24T22:30:12+08:00">2023-01-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论: </span>
  
    <a title="waline" href="/2020/12/26/mongodbomcreateshardedcluster.en/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2020/12/26/mongodbomcreateshardedcluster.en/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="waline-pageview-count" data-path="/2020/12/26/mongodbomcreateshardedcluster.en/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>MongoDB sharded cluster is the most complicated architecture. The
deployment of sharded cluster in Kubernetes is relatively hard. We will
go through the deployment process by MongoDB Ops Manager in this
post.</p>
<p>Before start, please go through the <a
href="/2020/12/19/mongodbomcreateuserdb.en/">Create a UserDB
ReplicaSet</a> first.</p>
<p>A MongoDB <a
target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-sharded-cluster">sharded
cluster</a> consists of the following components: - <a
target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/sharded-cluster-shards/">shard</a>:
Each shard contains a subset of the sharded data. Each shard can be
deployed as a <a
target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-replica-set">replica
set</a>. - <a
target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/sharded-cluster-query-router/">mongos</a>:
The <code>mongos</code> acts as a query router, providing an interface
between client applications and the sharded cluster. - <a
target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/sharded-cluster-config-servers/">config
servers</a>: Config servers store metadata and configuration settings
for the cluster.</p>
<p>In this post, we are going to create a sharded cluster with 2 shards
(3 instances replica set), 2 mongos and 3 config servers.</p>
<p>MongoDB Ops Manager Series:</p>
<ol type="1">
<li><a href="/2020/12/19/mongodbopsmanager.en/">Install MongoDB Ops
Manager</a></li>
<li><a href="/2020/12/19/mongodbomcreateuserdb.en/">Create a UserDB
ReplicaSet</a></li>
<li><a href="/2020/12/19/mongodbomexposeservices.en/">Expose UserDB to
Public</a></li>
<li><a href="/2020/12/19/mongodbomselfsignedcertificates.en/">Openssl
Generates Self-signed Certificates</a></li>
<li><a href="/2020/12/19/mongodbomtlsauth.en/">Enable UserDB TLS and
Auth</a></li>
</ol>
<span id="more"></span>
<h1 id="create-a-sharded-cluster">Create a Sharded Cluster</h1>
<p>The creation of public API key is omitted here. Please refer to <a
href="/2020/12/19/mongodbomcreateuserdb.en/">this post</a>.</p>
<p>Basically, the creation process consists of 3 steps. It seems that
the SSL migration plan created by the Ops Manager has bugs. Because of
this, if we deploy the sharded cluster as deploying the replica set, we
will stuck at TLS updating (explain in detail later).</p>
<p>Steps:</p>
<ol type="1">
<li>Initial deployment, set <code>mongodsPerShardCount</code> to 1, make
each shard contains only one server</li>
<li>Create self-signed certificates and enable TLS in the cluster</li>
<li>Set <code>mongodsPerShardCount</code> to 3 and update cluster to
make each shard a three instances cluster</li>
</ol>
<h2 id="initial-deployment">Initial Deployment</h2>
<p>Create a file <code>sharddb-step1.yaml</code>:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> mongodb.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MongoDB
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sharddb
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongodb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">shardCount</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">mongodsPerShardCount</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">mongosCount</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">configServerCount</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 4.2.2<span class="token punctuation">-</span>ent
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ShardedCluster

  <span class="token key atrule">opsManager</span><span class="token punctuation">:</span>
    <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ops<span class="token punctuation">-</span>manager<span class="token punctuation">-</span>connection
  <span class="token key atrule">credentials</span><span class="token punctuation">:</span> om<span class="token punctuation">-</span>user<span class="token punctuation">-</span>credentials
  <span class="token key atrule">exposedExternally</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

  <span class="token key atrule">shardPodSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
    <span class="token key atrule">persistence</span><span class="token punctuation">:</span>
      <span class="token key atrule">single</span><span class="token punctuation">:</span>
        <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token key atrule">configSrvPodSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
    <span class="token key atrule">persistence</span><span class="token punctuation">:</span>
      <span class="token key atrule">single</span><span class="token punctuation">:</span>
        <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token key atrule">mongosPodSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Explanation:</p>
<ol type="1">
<li>DO NOT add <code>security</code> section in this step. Otherwise,
the TLS update process will be failed.</li>
<li>We will expose the cluster to public by creating mongos service
instead of NodePort. Therefore, <code>exposedExternally</code> is set to
false.</li>
<li>Sample usage of shardPodSpec, configSrvPodSpec and mongosPodSpec is
shown above. Refer to: [MongoDB Database Resource
Specification](https://docs.mongodb.com/kubernetes-operator/master/reference/k8s-operator-specification/）</li>
</ol>
<p>Apply the yaml and we will see seven servers in the Ops Manager
server page: <img
src="https://coriva.eu.org/images/mongodb/sharddbstep1servers.png"
alt="MongoDB Sharded Cluster Step1 Servers" /></p>
<h2 id="expose-mongos-service">Expose mongos Service</h2>
<p>In order to access the cluster from the Internet, we need to create a
service for every mongos. Refer to: <a
href="/2021/01/13/dontuseloadbalancerinfrontofmongos.en/">Don't Use Load
Balancer In front of Mongos</a></p>
<p>Apply <code>sharddbmongosservice.yaml</code>:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongos<span class="token punctuation">-</span>svc<span class="token punctuation">-</span><span class="token number">0</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> sharddb<span class="token punctuation">-</span>svc
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>enterprise<span class="token punctuation">-</span>operator
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> sharddb<span class="token punctuation">-</span>svc
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>enterprise<span class="token punctuation">-</span>operator
    <span class="token key atrule">statefulset.kubernetes.io/pod-name</span><span class="token punctuation">:</span> sharddb<span class="token punctuation">-</span>mongos<span class="token punctuation">-</span><span class="token number">0</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongos<span class="token punctuation">-</span>svc<span class="token punctuation">-</span><span class="token number">1</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongodb
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> sharddb<span class="token punctuation">-</span>svc
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>enterprise<span class="token punctuation">-</span>operator
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> sharddb<span class="token punctuation">-</span>svc
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>enterprise<span class="token punctuation">-</span>operator
    <span class="token key atrule">statefulset.kubernetes.io/pod-name</span><span class="token punctuation">:</span> sharddb<span class="token punctuation">-</span>mongos<span class="token punctuation">-</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="create-server-certificates">Create Server Certificates</h2>
<p>CA Creation: <a
href="/2020/12/19/mongodbomselfsignedcertificates.en/">Openssl Generates
Self-signed Certificates</a></p>
<h3 id="config-server.cnf">Config <code>server.cnf</code></h3>
<p>The demo cluster consists of 11 servers: 2 * 3 = 6 shard servers, 2
mongos servers and 3 config servers.</p>
<p>The servers' external/internal endpoints:</p>
<pre class="line-numbers language-none"><code class="language-none">sharddb-mongos0.com
sharddb-mongos1.com
sharddb-0-0.sharddb-sh.mongodb.svc.cluster.local
sharddb-0-1.sharddb-sh.mongodb.svc.cluster.local
sharddb-0-2.sharddb-sh.mongodb.svc.cluster.local
sharddb-1-0.sharddb-sh.mongodb.svc.cluster.local
sharddb-1-1.sharddb-sh.mongodb.svc.cluster.local
sharddb-1-2.sharddb-sh.mongodb.svc.cluster.local
sharddb-config-0.sharddb-cs.mongodb.svc.cluster.local
sharddb-config-1.sharddb-cs.mongodb.svc.cluster.local
sharddb-config-2.sharddb-cs.mongodb.svc.cluster.local
sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local
sharddb-mongos-1.sharddb-svc.mongodb.svc.cluster.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Use wildcard to make it more compact:</p>
<pre class="line-numbers language-none"><code class="language-none">[ alt_names ]
DNS.1 &#x3D; sharddb-mongos0.com
DNS.2 &#x3D; sharddb-mongos1.com
DNS.3 &#x3D; *.sharddb-sh.mongodb.svc.cluster.local
DNS.4 &#x3D; *.sharddb-cs.mongodb.svc.cluster.local
DNS.5 &#x3D; *.sharddb-svc.mongodb.svc.cluster.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>DO NOT write them like this as it doesn't work:</p>
<pre class="line-numbers language-none"><code class="language-none">[ alt_names ]
DNS.1 &#x3D; sharddb-mongos0.com
DNS.2 &#x3D; sharddb-mongos1.com
DNS.3 &#x3D; *.mongodb.svc.cluster.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Refer to: <a
target="_blank" rel="noopener" href="https://www.globalsign.com/en/blog/top-ssl-certificate-errors-and-solutions">#
Common SSL Certificate Errors and How to Fix Them</a></p>
<blockquote>
<p>Subdomain SANs are applicable to all host names extending the Common
Name by one level. For example: support.domain.com could be a Subdomain
SAN for a certificate with the Common Name domain.com
advanced.support.domain.com could NOT be covered by a Subdomain SAN in a
certificate issued to domain.com, as it is not a direct subdomain of
domain.com</p>
</blockquote>
<p>Final version of <code>server.cnf</code>:</p>
<pre class="line-numbers language-none"><code class="language-none">[ req ]
default_bits &#x3D; 4096
default_md &#x3D; sha256
distinguished_name &#x3D; req_dn
req_extensions &#x3D; v3_req

[ v3_req ]
subjectKeyIdentifier  &#x3D; hash
basicConstraints &#x3D; CA:FALSE
keyUsage &#x3D; critical, digitalSignature, keyEncipherment
nsComment &#x3D; &quot;OpenSSL Generated Certificate for TESTING only.  NOT FOR PRODUCTION USE.&quot;
extendedKeyUsage  &#x3D; serverAuth, clientAuth
subjectAltName &#x3D; @alt_names

[ alt_names ]
DNS.1 &#x3D; sharddb-mongos0.com
DNS.2 &#x3D; sharddb-mongos1.com
DNS.3 &#x3D; *.sharddb-sh.mongodb.svc.cluster.local
DNS.4 &#x3D; *.sharddb-cs.mongodb.svc.cluster.local
DNS.5 &#x3D; *.sharddb-svc.mongodb.svc.cluster.local

[ req_dn ]
countryName &#x3D; Country Name (2 letter code)
countryName_default &#x3D; CN

countryName_min &#x3D; 2
countryName_max &#x3D; 2

stateOrProvinceName &#x3D; State or Province Name (full name)
stateOrProvinceName_default &#x3D; Beijing
stateOrProvinceName_max &#x3D; 64

localityName &#x3D; Locality Name (eg, city)
localityName_default &#x3D; Beijing
localityName_max &#x3D; 64

organizationName &#x3D; Organization Name (eg, company)
organizationName_default &#x3D; TestComp
organizationName_max &#x3D; 64

organizationalUnitName &#x3D; Organizational Unit Name (eg, section)
organizationalUnitName_default &#x3D; TestComp
organizationalUnitName_max &#x3D; 64

commonName &#x3D; Common Name (eg, YOUR name)
commonName_max &#x3D; 64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="generate-server-certificate">Generate Server Certificate</h3>
<p>Use the following 4 commands to generate private key
<code>server.key</code>, signed it by the <code>rootca.key</code> and
create <code>server.pem</code>:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ openssl genrsa <span class="token parameter variable">-out</span> server.key <span class="token number">4096</span>
$ openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-key</span> server.key <span class="token parameter variable">-out</span> server.csr <span class="token parameter variable">-config</span> server.cnf
$ openssl x509 <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-req</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-in</span> server.csr <span class="token parameter variable">-CA</span> rootca.crt <span class="token parameter variable">-CAkey</span> rootca.key <span class="token parameter variable">-CAcreateserial</span> <span class="token parameter variable">-out</span> server.crt <span class="token parameter variable">-extfile</span> server.cnf <span class="token parameter variable">-extensions</span> v3_req
$ <span class="token function">cat</span> server.crt server.key <span class="token operator">></span> server.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Sample output reference: <a
href="/2020/12/19/mongodbomselfsignedcertificates.en/">Openssl Generates
Self-signed Certificates</a></p>
<h3 id="copy-to-get-11-server-certificates">Copy to Get 11 Server
Certificates</h3>
<p>Rename the files by rules:</p>
<table>
<thead>
<tr class="header">
<th>File</th>
<th>Save as</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CA</td>
<td>ca-pem</td>
</tr>
<tr class="even">
<td>Each shard in your sharded cluster</td>
<td><code>sharddb-&lt;Y&gt;-&lt;X&gt;-pem</code></td>
</tr>
<tr class="odd">
<td>Each member of your config server replica set</td>
<td><code>sharddb-config-&lt;X&gt;-pem</code></td>
</tr>
<tr class="even">
<td>Each mongos</td>
<td><code>sharddb-mongos-&lt;X&gt;-pem</code></td>
</tr>
</tbody>
</table>
<ul>
<li>Replace <code>&lt;Y&gt;</code> with a 0-based number for the sharded
cluster.</li>
<li>Replace <code>&lt;X&gt;</code> with the member of a shard or replica
set.</li>
</ul>
<h2 id="create-server-certificate-and-ca-configmap">Create Server
Certificate and CA ConfigMap</h2>
<h3 id="create-shards-server-certificate-secret">Create Shards Server
Certificate Secret</h3>
<pre class="line-numbers language-none"><code class="language-none">$ kubectl create secret generic sharddb-0-cert --from-file&#x3D;sharddb-0-0-pem --from-file&#x3D;sharddb-0-1-pem --from-file&#x3D;sharddb-0-2-pem
$ kubectl create secret generic sharddb-1-cert --from-file&#x3D;sharddb-1-0-pem --from-file&#x3D;sharddb-1-1-pem --from-file&#x3D;sharddb-1-2-pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="create-config-server-certificate-secret">Create Config Server
Certificate Secret</h3>
<pre class="line-numbers language-none"><code class="language-none">$ kubectl create secret generic sharddb-config-cert --from-file&#x3D;sharddb-config-0-pem --from-file&#x3D;sharddb-config-1-pem --from-file&#x3D;sharddb-config-2-pem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="create-mongos-server-certificate-secret">Create Mongos Server
Certificate Secret</h3>
<pre class="line-numbers language-none"><code class="language-none">$ kubectl create secret generic sharddb-mongos-cert --from-file&#x3D;sharddb-mongos-0-pem --from-file&#x3D;sharddb-mongos-1-pem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="create-ca-configmap">Create CA ConfigMap</h3>
<p>Rename <code>rootca.crt -&gt; ca-pem</code>:</p>
<pre class="line-numbers language-none"><code class="language-none">kubectl create configmap custom-ca --from-file&#x3D;ca-pem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="enable-tls">Enable TLS</h2>
<p>Refer to：<a
target="_blank" rel="noopener" href="https://docs.mongodb.com/kubernetes-operator/master/tutorial/secure-tls/#configure-tls-for-a-sharded-cluster">#
Configure TLS for a Sharded Cluster</a></p>
<p>Compared to step1, <code>sharddb-step2.yaml</code> only appends
<code>security</code> section. Note that now the
<code>mongodsPerShardCount</code> is still 1:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> mongodb.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MongoDB
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sharddb
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongodb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">shardCount</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">mongodsPerShardCount</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">mongosCount</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">configServerCount</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 4.2.2<span class="token punctuation">-</span>ent
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ShardedCluster

  <span class="token key atrule">opsManager</span><span class="token punctuation">:</span>
    <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ops<span class="token punctuation">-</span>manager<span class="token punctuation">-</span>connection
  <span class="token key atrule">credentials</span><span class="token punctuation">:</span> om<span class="token punctuation">-</span>user<span class="token punctuation">-</span>credentials
  <span class="token key atrule">exposedExternally</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

  <span class="token key atrule">shardPodSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
    <span class="token key atrule">persistence</span><span class="token punctuation">:</span>
      <span class="token key atrule">single</span><span class="token punctuation">:</span>
        <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token key atrule">configSrvPodSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
    <span class="token key atrule">persistence</span><span class="token punctuation">:</span>
      <span class="token key atrule">single</span><span class="token punctuation">:</span>
        <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token key atrule">mongosPodSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi

  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">ca</span><span class="token punctuation">:</span> custom<span class="token punctuation">-</span>ca<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Here the <code>mongodsPerShardCount</code> must be 1. Otherwise, the
update operation will stuck when you enable TLS. In short, the reason is
that a replica set's migration plan must be in order, and the servers in
the replica set must be updated in the same pace. SSL update plan has 3
steps:
<code>disabled -&gt; sslAllowed -&gt; sslPreferred -&gt; sslRequired</code>.
If one server updates to <code>sslRequired</code> while others are still
<code>disabled</code>, the disabled one cannot connect to the
<code>sslRequired</code> server. The whole updating process will stuck.
We will explain this issue in the last part.</p>
<p>Apply <code>sharddb-step2.yaml</code>, the Ops Manager will first
update the config servers, then the shard servers in reverse order: <img
src="https://coriva.eu.org/images/mongodb/sharddbtlsupdating.png"
alt="MongoDB Sharded Cluster Step2 Updating" /></p>
<p>Enable TLS success: <img
src="https://coriva.eu.org/images/mongodb/sharddbstep2processes.png"
alt="MongoDB Sharded Cluster Step2 Processes" /></p>
<h2 id="set-mongodspershardcount-to-3">Set mongodsPerShardCount to
3</h2>
<p>Compared to step2, <code>sharddb-step3.yaml</code> only changes
<code>mongodsPerShardCount</code>:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> mongodb.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MongoDB
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sharddb
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongodb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">shardCount</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">mongodsPerShardCount</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">mongosCount</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">configServerCount</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 4.2.2<span class="token punctuation">-</span>ent
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ShardedCluster

  <span class="token key atrule">opsManager</span><span class="token punctuation">:</span>
    <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ops<span class="token punctuation">-</span>manager<span class="token punctuation">-</span>connection
  <span class="token key atrule">credentials</span><span class="token punctuation">:</span> om<span class="token punctuation">-</span>user<span class="token punctuation">-</span>credentials
  <span class="token key atrule">exposedExternally</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

  <span class="token key atrule">shardPodSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
    <span class="token key atrule">persistence</span><span class="token punctuation">:</span>
      <span class="token key atrule">single</span><span class="token punctuation">:</span>
        <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token key atrule">configSrvPodSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
    <span class="token key atrule">persistence</span><span class="token punctuation">:</span>
      <span class="token key atrule">single</span><span class="token punctuation">:</span>
        <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token key atrule">mongosPodSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi

  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">ca</span><span class="token punctuation">:</span> custom<span class="token punctuation">-</span>ca<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Apply <code>sharddb-step3.yaml</code>: <img
src="https://coriva.eu.org/images/mongodb/sharddbstep3servers.png"
alt="MongoDB Sharded Cluster Step3 Servers" /></p>
<p>The final status (Enable AUTH from UI): <img
src="https://coriva.eu.org/images/mongodb/sharddbstep3processes.png"
alt="MongoDB Sharded Cluster Deploy Success" /></p>
<h1 id="errors-and-solution">Errors and Solution</h1>
<h2 id="invalid-certificates">Invalid Certificates</h2>
<p>If the certificates' SAN cannot match the server address, the
following error happens (view the agent log):</p>
<blockquote>
<p>Error checking out client (0x0) for
connParam=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : [06:36:25.568] Error dialing
to
connParams=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false): tried 1 identities, but none of them worked. They were
()</p>
<p>Failed to compute states : <sharddb-0-0> [06:36:25.568] Error calling
ComputeState : <sharddb-0-0> [06:36:25.568] Error getting fickle state
for current state : <sharddb-0-0> [06:36:25.568] Error checking if
mongos = sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) is up : <sharddb-0-0> [06:36:25.568] Error executing
WithClientFor() for
cp=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : <sharddb-0-0> [06:36:25.568]
Error checking out client (0x0) for
connParam=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : [06:36:25.568] Error dialing
to
connParams=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false): tried 1 identities, but none of them worked. They were
()</p>
<p>Failed to planAndExecute : <sharddb-0-0> [06:36:25.568] Failed to
compute states : <sharddb-0-0> [06:36:25.568] Error calling ComputeState
: <sharddb-0-0> [06:36:25.568] Error getting fickle state for current
state : <sharddb-0-0> [06:36:25.568] Error checking if mongos =
sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) is up : <sharddb-0-0> [06:36:25.568] Error executing
WithClientFor() for
cp=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : <sharddb-0-0> [06:36:25.568]
Error checking out client (0x0) for
connParam=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : [06:36:25.568] Error dialing
to
connParams=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false): tried 1 identities, but none of them worked. They were
()</p>
<p>Error checking if mongos =
sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) is up : <sharddb-0-0> [06:36:25.568] Error executing
WithClientFor() for
cp=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : <sharddb-0-0> [06:36:25.568]
Error checking out client (0x0) for
connParam=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : [06:36:25.568] Error dialing
to
connParams=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false): tried 1 identities, but none of them worked. They were
()</p>
<p>Error getting fickle state for current state : <sharddb-0-0>
[06:36:25.568] Error checking if mongos =
sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) is up : <sharddb-0-0> [06:36:25.568] Error executing
WithClientFor() for
cp=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : <sharddb-0-0> [06:36:25.568]
Error checking out client (0x0) for
connParam=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : [06:36:25.568] Error dialing
to
connParams=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false): tried 1 identities, but none of them worked. They were
()</p>
<p>Error calling ComputeState : <sharddb-0-0> [06:36:25.568] Error
getting fickle state for current state : <sharddb-0-0> [06:36:25.568]
Error checking if mongos =
sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) is up : <sharddb-0-0> [06:36:25.568] Error executing
WithClientFor() for
cp=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : <sharddb-0-0> [06:36:25.568]
Error checking out client (0x0) for
connParam=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false) connectMode=SingleConnect : [06:36:25.568] Error dialing
to
connParams=sharddb-mongos-0.sharddb-svc.mongodb.svc.cluster.local:27017
(local=false): tried 1 identities, but none of them worked. They were
()</p>
<p>mongod cannot perform Global Update Action because configSvr process
= (sharddb-config-2.sharddb-cs.mongodb.svc.cluster.local:27017) is not
healthy and done</p>
</blockquote>
<p>Similar to replica set deployment, double check
<code>server.cnf</code>, re-generate certificates and re-deploy.</p>
<h2 id="enable-tls-when-mongodspershardcount-is-3">Enable TLS when
mongodsPerShardCount is 3</h2>
<p>The cluster update is stuck: <img
src="https://coriva.eu.org/images/mongodb/updateplanerror.png"
alt="MongoDB Sharded Cluster SSL Update Plan Error" /></p>
<p>Look at the server log and check if the SSL migration plan is wrong.
For example, this is a shard server at the stage of
<code>disabled -&gt; sslAllowed</code>:</p>
<blockquote>
<p>{"logType":"automation-agent-verbose","contents":"[2020/12/26
09:19:10.024] [.info] [cm/director/director.go:executePlan:866]
<sharddb-0-0> [09:19:10.024] Running step 'WaitSSLUpdate' as part of
move 'UpgradeSSLModeFromAllowedToPrefered'"}
{"logType":"automation-agent-verbose","contents":"[2020/12/26
09:19:10.024] [.info] [cm/director/director.go:tracef:771] <sharddb-0-0>
[09:19:10.024] Precondition of 'WaitSSLUpdate' applies because "}
{"logType":"automation-agent-verbose","contents":"['currentState.Up' =
true]"} {"logType":"automation-agent-verbose","contents":"[2020/12/26
09:19:10.024] [.info] [cm/director/director.go:planAndExecute:534]
<sharddb-0-0> [09:19:10.024] Step=WaitSSLUpdate as part of
Move=UpgradeSSLModeFromAllowedToPrefered in plan failed : ."}
{"logType":"automation-agent-verbose","contents":" Recomputing a
plan..."} {"logType":"automation-agent-verbose","contents":"[2020/12/26
09:19:10.132] [.info] [main/components/agent.go:LoadClusterConfig:197]
[09:19:10.132] clusterConfig unchanged"}
{"logType":"mongodb","contents":"2020-12-26T09:19:11.078+0000 I NETWORK
[listener] connection accepted from 10.240.7.82:40502 #76924 (42
connections now open)"}
{"logType":"mongodb","contents":"2020-12-26T09:19:11.088+0000 W NETWORK
[conn76924] no SSL certificate provided by peer"}
{"logType":"automation-agent-verbose","contents":"[2020/12/26
09:19:11.142] [.info] [main/components/agent.go:LoadClusterConfig:197]
[09:19:11.142] clusterConfig unchanged"}
{"logType":"mongodb","contents":"2020-12-26T09:19:11.151+0000 I CONNPOOL
[Replication] Connecting to
sharddb-0-2.sharddb-sh.mongodb.svc.cluster.local:27017"}
{"logType":"automation-agent-stdout","contents":"<sharddb-0-0>
[09:19:11.158] ... process has a plan :
UpgradeSSLModeFromAllowedToPrefered,UpgradeSSLModeFromPreferedToRequired"}
{"logType":"automation-agent-stdout","contents":"<sharddb-0-0>
[09:19:11.158] Running step 'CheckSSLAllowedAndWantSSLPrefered' as part
of move 'UpgradeSSLModeFromAllowedToPrefered'"}
{"logType":"automation-agent-verbose","contents":"[2020/12/26
09:19:11.158] [.info] [cm/director/director.go:computePlan:269]
<sharddb-0-0> [09:19:11.158] ... process has a plan :
UpgradeSSLModeFromAllowedToPrefered,UpgradeSSLModeFromPreferedToRequired"}
{"logType":"automation-agent-stdout","contents":"<sharddb-0-0>
[09:19:11.158] Running step 'WaitSSLUpdate' as part of move
'UpgradeSSLModeFromAllowedToPrefered'"}
{"logType":"mongodb","contents":"2020-12-26T09:19:11.161+0000 I REPL_HB
[replexec-8] Heartbeat to
sharddb-0-2.sharddb-sh.mongodb.svc.cluster.local:27017 failed after 2
retries, response status: HostUnreachable: Connection closed by peer"}
{"logType":"automation-agent-verbose","contents":"[2020/12/26
09:19:11.158] [.info] [cm/director/director.go:executePlan:866]
<sharddb-0-0> [09:19:11.158] Running step
'CheckSSLAllowedAndWantSSLPrefered' as part of move
'UpgradeSSLModeFromAllowedToPrefered'"}
{"logType":"automation-agent-verbose","contents":"[2020/12/26
09:19:11.158] [.info] [cm/director/director.go:tracef:771] <sharddb-0-0>
[09:19:11.158] Precondition of 'CheckSSLAllowedAndWantSSLPrefered'
applies because "}
{"logType":"automation-agent-verbose","contents":"[All the following are
true: "} {"logType":"automation-agent-verbose","contents":"
['currentState.Up' = true]"}
{"logType":"automation-agent-verbose","contents":" [All the following
are true: "} {"logType":"automation-agent-verbose","contents":" [All
BOUNCE_RESTART process args are equivalent :"}
{"logType":"automation-agent-verbose","contents":" [&lt;'storage.engine'
is equal: absent in desiredArgs=map[dbPath:/data], and default
value=wiredTiger in currentArgs=map[dbPath:/data
engine:wiredTiger]&gt;]"}
{"logType":"automation-agent-verbose","contents":"
[&lt;'processManagement' is equal: absent in
desiredArgs=map[net:map[bindIp:0.0.0.0 port:27017
ssl:map[CAFile:/mongodb-automation/ca.pem
PEMKeyFile:/mongodb-automation/server.pem
allowConnectionsWithoutCertificates:true mode:requireSSL]]
replication:map[replSetName:sharddb-0]
sharding:map[clusterRole:shardsvr] storage:map[dbPath:/data]
systemLog:map[destination:file
path:/var/log/mongodb-mms-automation/mongodb.log]], and default
value=map[] in currentArgs=map[net:map[bindIp:0.0.0.0 port:27017
ssl:map[CAFile:/mongodb-automation/ca.pem
PEMKeyFile:/mongodb-automation/server.pem
allowConnectionsWithoutCertificates:true mode:allowSSL]]
processManagement:map[] replication:map[replSetName:sharddb-0]
sharding:map[clusterRole:shardsvr] storage:map[dbPath:/data
engine:wiredTiger] systemLog:map[destination:file
path:/var/log/mongodb-mms-automation/mongodb.log]]&gt;]"}
{"logType":"automation-agent-verbose","contents":" ]"}
{"logType":"automation-agent-verbose","contents":"
[<curAuthInfo is nil>]"}
{"logType":"automation-agent-verbose","contents":" ]"}
{"logType":"automation-agent-verbose","contents":" ['SSL mode' =
allowSSL]"} {"logType":"automation-agent-verbose","contents":" ['SSL
mode' = requireSSL]"}
{"logType":"automation-agent-verbose","contents":"]"}</p>
</blockquote>
<p>Look another shard server which is <code>Goal State</code>:</p>
<blockquote>
<p>{"logType":"mongodb","contents":"2020-12-26T09:33:57.679+0000 I
NETWORK [conn348143] end connection 10.240.7.120:51662 (19 connections
now open)"}
{"logType":"mongodb","contents":"2020-12-26T09:33:57.728+0000 I NETWORK
[listener] connection accepted from 10.240.5.150:57414 #348144 (20
connections now open)"}
{"logType":"mongodb","contents":"2020-12-26T09:33:57.728+0000 I NETWORK
[conn348144] Error receiving request from client: SSLHandshakeFailed:
The server is configured to only allow SSL connections. Ending
connection from 10.240.5.150:57414 (connection id: 348144)"}
{"logType":"mongodb","contents":"2020-12-26T09:33:57.728+0000 I NETWORK
[conn348144] end connection 10.240.5.150:57414 (19 connections now
open)"} {"logType":"mongodb","contents":"2020-12-26T09:33:57.733+0000 I
NETWORK [listener] connection accepted from 10.240.5.150:57416 #348145
(20 connections now open)"}
{"logType":"mongodb","contents":"2020-12-26T09:33:57.733+0000 I NETWORK
[conn348145] Error receiving request from client: SSLHandshakeFailed:
The server is configured to only allow SSL connections. Ending
connection from 10.240.5.150:57416 (connection id: 348145)"}</p>
</blockquote>
<p>Apparently, the <code>Goal State</code> server requires TLS while the
<code>disabled</code> server not use TLS. Then the connection from the
<code>disabled</code> server is rejected. I don't find a graceful
solution to resolve this issue (a bug of MongoDB Kubernetes Operator?).
Currently, the only way to bypass this issue is make each shard one
instance and increase the instance number after enabling TLS.</p>
<h1 id="delete-sharded-cluster">Delete Sharded Cluster</h1>
<p>If you want to re-deploy the cluster, use this command to delete the
cluster:</p>
<pre class="line-numbers language-none"><code class="language-none">kubectl.exe delete mdb sharddb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Note that shard server and config server are stateful as they claim
persistent volume (PV). The above command will not delete the PV in
Kubernetes. Therefore, you need to delete all PVs to clean up the
status.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MongoDB/" rel="tag"># MongoDB</a>
              <a href="/tags/MongoDB-Ops-Manager/" rel="tag"># MongoDB Ops Manager</a>
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
              <a href="/tags/Sharding/" rel="tag"># Sharding</a>
              <a href="/tags/TLS/" rel="tag"># TLS</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/12/26/mongodbomcreateshardedcluster/" rel="prev" title="部署Kubernetes MongoDB Sharded Cluster">
                  <i class="fa fa-chevron-left"></i> 部署Kubernetes MongoDB Sharded Cluster
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/01/03/lightsquidhardcodeyear.en/" rel="next" title="Lightsquid Stop Working in 2021">
                  Lightsquid Stop Working in 2021 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">finisky</span>
</div><div><span class="post-meta-item-icon"><i class="far fa-eye"></i></span><span><a href="https://finicounter.eu.org/" target="_blank">Total Views</a>:</span><span id="finicount_views" style="display:inline;padding-left:5px;"></span><div> <script async src="//finicounter.eu.org/finicounter.js"></script>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/finisky" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  




  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"en","enable":true,"serverURL":"https://comments.finisky.eu.org","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":true,"pageSize":10,"el":"#waline","comment":true,"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","path":"/2020/12/26/mongodbomcreateshardedcluster.en/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>


        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body>
</html>
