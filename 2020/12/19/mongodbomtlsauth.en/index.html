<!DOCTYPE html>
<html lang="en">
<head><!-- hexo injector head_begin start --><!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-K4DEGPDYSW"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag("js", new Date()); gtag("config", "G-K4DEGPDYSW"); </script><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">
  <meta name="google-site-verification" content="oFhcvcGsjsTY5AFUaI-ezbn7-bel9NrdUNpeQfwZSwI">
  <meta name="msvalidate.01" content="F8E2F274161B653649F8818FD127CE87">
  <meta name="yandex-verification" content="ff1f79abcbf80d7e">
  <meta name="baidu-site-verification" content="code-nNL5JO7sPl">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"finisky.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="This is part5, we will use the generated certficates to enable user database TLS and AUTH. MongoDB Ops Manager Series:  Install MongoDB Ops Manager Create a UserDB ReplicaSet Expose UserDB to Public O">
<meta property="og:type" content="article">
<meta property="og:title" content="MongoDB Cluster In Kubernetes(5): Enable UserDB TLS and Auth">
<meta property="og:url" content="https://finisky.github.io/2020/12/19/mongodbomtlsauth.en/index.html">
<meta property="og:site_name" content="Finisky Garden">
<meta property="og:description" content="This is part5, we will use the generated certficates to enable user database TLS and AUTH. MongoDB Ops Manager Series:  Install MongoDB Ops Manager Create a UserDB ReplicaSet Expose UserDB to Public O">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-12-19T15:45:32.000Z">
<meta property="article:modified_time" content="2023-01-24T14:30:12.000Z">
<meta property="article:author" content="finisky">
<meta property="article:tag" content="MongoDB">
<meta property="article:tag" content="MongoDB Ops Manager">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="TLS">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://finisky.github.io/2020/12/19/mongodbomtlsauth.en/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://finisky.github.io/2020/12/19/mongodbomtlsauth.en/","path":"/2020/12/19/mongodbomtlsauth.en/","title":"MongoDB Cluster In Kubernetes(5): Enable UserDB TLS and Auth"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MongoDB Cluster In Kubernetes(5): Enable UserDB TLS and Auth | Finisky Garden</title>
  







<link rel="dns-prefetch" href="https://comments.finisky.eu.org">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script type="text/javascript"> function downloadJsAtOnload() { setTimeout(function downloadJs() { var element = document.createElement("script"); element.setAttribute("data-ad-client", "ca-pub-2660281922577700"); element.async = true; element.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"; document.body.appendChild(element); }, 5000); }; if (window.addEventListener) window.addEventListener("load", downloadJsAtOnload, false); else if (window.attachEvent) window.attachEvent("onload", downloadJsAtOnload); else window.onload = downloadJsAtOnload; </script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Finisky Garden" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Finisky Garden</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">NLP, 软件工程, 产品设计</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-nlp"><a href="/tags/NLP/" rel="section"><i class="fa fa-language fa-fw"></i>NLP</a></li><li class="menu-item menu-item-mongodb"><a href="/categories/MongoDB/" rel="section"><i class="fas fa-database fa-fw"></i>MongoDB</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-友链"><a href="/links/" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#understanding-different-secure-connections"><span class="nav-number">1.</span> <span class="nav-text">Understanding
Different Secure Connections</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#upload-certificates-to-kubernetes-cluster"><span class="nav-number">2.</span> <span class="nav-text">Upload Certificates
to Kubernetes Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#create-server-secret"><span class="nav-number">2.1.</span> <span class="nav-text">Create Server Secret</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create-ca-configmap"><span class="nav-number">2.2.</span> <span class="nav-text">Create CA ConfigMap</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#update-user-database-replicasethorizons"><span class="nav-number">3.</span> <span class="nav-text">Update User Database
replicaSetHorizons</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#error-calling-computestate-error-dialing-to-connparams-error-checking-if-rs-member-is-up-error"><span class="nav-number">3.1.</span> <span class="nav-text">Error calling ComputeState,
Error dialing to connParams,
Error checking if rs member is up Error</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#conect-to-userdb"><span class="nav-number">4.</span> <span class="nav-text">Conect to UserDB</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#enable-auth"><span class="nav-number">5.</span> <span class="nav-text">Enable AUTH</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#summary"><span class="nav-number">6.</span> <span class="nav-text">Summary</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="finisky"
      src="/images/qrcode.jpg">
  <p class="site-author-name" itemprop="name">扫码关注公众号</p>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">265</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2020/12/19/mongodbomselfsignedcertificates.en/" rel="bookmark">
        <time class="popular-posts-time">2020-12-19</time>
        <br>
      MongoDB Cluster In Kubernetes(4): Openssl Generates Self-signed Certificates
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2020/12/19/mongodbomcreateuserdb.en/" rel="bookmark">
        <time class="popular-posts-time">2020-12-19</time>
        <br>
      MongoDB Cluster In Kubernetes(2): Create a UserDB ReplicaSet
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2020/12/19/mongodbomexposeservices.en/" rel="bookmark">
        <time class="popular-posts-time">2020-12-19</time>
        <br>
      MongoDB Cluster In Kubernetes(3): Expose UserDB to Public
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2019/07/23/cloudservicekeyset/" rel="bookmark">
        <time class="popular-posts-time">2019-07-23</time>
        <br>
      Azure CloudService Deployment "Keyset does not exist"
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2020/12/19/mongodbopsmanager.en/" rel="bookmark">
        <time class="popular-posts-time">2020-12-19</time>
        <br>
      MongoDB Cluster In Kubernetes(1): Install MongoDB Ops Manager
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/2020/12/19/mongodbomtlsauth.en/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MongoDB Cluster In Kubernetes(5): Enable UserDB TLS and Auth | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MongoDB Cluster In Kubernetes(5): Enable UserDB TLS and Auth
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-19 23:45:32" itemprop="dateCreated datePublished" datetime="2020-12-19T23:45:32+08:00">2020-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-01-24 22:30:12" itemprop="dateModified" datetime="2023-01-24T22:30:12+08:00">2023-01-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论: </span>
  
    <a title="waline" href="/2020/12/19/mongodbomtlsauth.en/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2020/12/19/mongodbomtlsauth.en/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="waline-pageview-count" data-path="/2020/12/19/mongodbomtlsauth.en/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>This is part5, we will use the generated certficates to enable user
database TLS and AUTH.</p>
<p>MongoDB Ops Manager Series:</p>
<ol type="1">
<li><a href="/2020/12/19/mongodbopsmanager.en/">Install MongoDB Ops
Manager</a></li>
<li><a href="/2020/12/19/mongodbomcreateuserdb.en/">Create a UserDB
ReplicaSet</a></li>
<li><a href="/2020/12/19/mongodbomexposeservices.en/">Expose UserDB to
Public</a></li>
<li><a href="/2020/12/19/mongodbomselfsignedcertificates.en/">Openssl
Generates Self-signed Certificates</a></li>
<li><a href="/2020/12/19/mongodbomtlsauth.en/">Enable UserDB TLS and
Auth</a></li>
</ol>
<span id="more"></span>
<h1 id="understanding-different-secure-connections">Understanding
Different Secure Connections</h1>
<p>Before we start, look at the following three TLS:</p>
<ul>
<li>Secure Connections to Ops Manager</li>
<li>Secure Connections to Application Database</li>
<li>Secure Connections to MongoDB Deployments</li>
</ul>
<p>A picture is worth a thousand words: <img
src="https://coriva.eu.org/images/mongodb/securedifferentconnections.png"
alt="Different Level of Security" /></p>
<p>What we want is the last one:
<code>Enable TLS to MongoDB Deployments</code>. Unfortunately, this
configuration cannot be performed through Ops Manger web UI as well.
Because we need to "upload" certificate to each server but the UI does
not has such capability.</p>
<p>If you read the Ops Manager document <a
target="_blank" rel="noopener" href="https://docs.opsmanager.mongodb.com/current/tutorial/enable-ssl-for-a-deployment/#get-and-install-the-tls-certificate-on-each-mongodb-host">#
Enable TLS for a Deployment</a>:</p>
<blockquote><p>Get and Install the TLS Certificate on Each MongoDB Host</p>
<p>Acquire a TLS certificate for each host serving a MongoDB process.
This certificate must include the FQDN for the hostname of this MongoDB
host. The FQDN can be the Common Name or the Subject Alternative Name of
this host. You must install this TLS certificate on the MongoDB
host.</p>
</blockquote>
<p>It's likely that you still don't know how to install the certificate.
Actually, what we want is <code>MongoDB Kubernetes Operator</code>'s
documentation: <a
target="_blank" rel="noopener" href="https://docs.mongodb.com/kubernetes-operator/master/tutorial/secure-tls/">#
Secure Deployments using TLS</a>.</p>
<p>By the way, when I first come to this step, I tried to copy the
certificate to the statefulset pod by <code>kubectl cp</code>. However,
when I <code>kubectl exec</code> to the pod I know it's not
feasible:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">groups: cannot <span class="token function">find</span> name <span class="token keyword">for</span> group ID <span class="token number">2000</span>
I have no name<span class="token operator">!</span>@mongo-1:/$ <span class="token function">cat</span> <span class="token operator">></span> ca.crt
bash: ca.crt: Permission denied
I have no name<span class="token operator">!</span>@mongo-1:/$ <span class="token function">whoami</span>
whoami: cannot <span class="token function">find</span> name <span class="token keyword">for</span> user ID <span class="token number">2000</span>
I have no name<span class="token operator">!</span>@mongo-1:/$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The pod is really weird, login with a username/group
<code>2000</code>. I also consider using <code>mount volume</code> to
mount the certificate but not have a try because I found the right
way.</p>
<p>Another article for your reference: <a
target="_blank" rel="noopener" href="https://developer.ibm.com/technologies/databases/tutorials/secure-mongo-db-enterprise-on-red-hat-openshift/">#
Secure MongoDB Enterprise on Red Hat OpenShift</a></p>
<h1 id="upload-certificates-to-kubernetes-cluster">Upload Certificates
to Kubernetes Cluster</h1>
<h2 id="create-server-secret">Create Server Secret</h2>
<p>First, rename the four certficates like this:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>Save As</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>rootca.crt</td>
<td>ca-pem</td>
</tr>
<tr class="even">
<td>userdbX.pem</td>
<td>userdb-X-pem</td>
</tr>
</tbody>
</table>
<p>Tips: End the PEM files with <code>-pem</code> and not
<code>.pem</code>. These files shouldn’t have a file extension.</p>
<p>Three server certificate format: <pre class="line-numbers language-none"><code class="language-none">-----BEGIN CERTIFICATE-----
...
... your TLS certificate
...
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
...
... your private key
...
-----END RSA PRIVATE KEY----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>Comparatively, the <code>rootca.crt</code> only have certficate
without private key: <pre class="line-numbers language-none"><code class="language-none">-----BEGIN CERTIFICATE-----
...
... your TLS certificate
...
-----END CERTIFICATE-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>Create a secret to store three server certficates: <pre class="line-numbers language-none"><code class="language-none">$ kubectl create secret generic userdb-cert --from-file&#x3D;userdb-0-pem --from-file&#x3D;userdb-1-pem  --from-file&#x3D;userdb-2-pem -n mongodb
secret&#x2F;userdb-cert created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<h2 id="create-ca-configmap">Create CA ConfigMap</h2>
<pre class="line-numbers language-none"><code class="language-none">$ kubectl create configmap custom-ca --from-file&#x3D;ca-pem -n mongodb
configmap&#x2F;custom-ca created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="update-user-database-replicasethorizons">Update User Database
<code>replicaSetHorizons</code></h1>
<p>Remember at <a href="/2020/12/19/mongodbomexposeservices.en/">Part
3</a>:</p>
<hr />
<p>To solve the problem, we need to use <a
target="_blank" rel="noopener" href="https://docs.mongodb.com/kubernetes-operator/master/reference/k8s-operator-specification/#spec.connectivity.replicaSetHorizons"><code>spec.connectivity.replicaSetHorizons</code></a>
to specify the public address. However, to use this setting,
<code>spec.security.tls</code> must be enabled first:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">connectivity</span><span class="token punctuation">:</span>
    <span class="token key atrule">replicaSetHorizons</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">"userdb"</span><span class="token punctuation">:</span> <span class="token string">"userdb0.com:27017"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">"userdb"</span><span class="token punctuation">:</span> <span class="token string">"userdb1.com:27017"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">"userdb"</span><span class="token punctuation">:</span> <span class="token string">"userdb2.com:27017"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The bad news is that enable TLS is more complicated than I thought
before. Here we use self-signed certificates to encrypt the transport
layer communication. Four certificates are required: 1 CA certificate
and 3 server certificates.</p>
<hr />
<p>Now comes to the <code>userdb.yaml</code> and add the
<code>security</code> section:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> mongodb.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MongoDB
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> userdb
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongodb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">members</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 4.2.2<span class="token punctuation">-</span>ent
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ReplicaSet

  <span class="token key atrule">opsManager</span><span class="token punctuation">:</span>
    <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ops<span class="token punctuation">-</span>manager<span class="token punctuation">-</span>connection
  <span class="token key atrule">credentials</span><span class="token punctuation">:</span> ops<span class="token punctuation">-</span>manager<span class="token punctuation">-</span>admin<span class="token punctuation">-</span>key
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">ca</span><span class="token punctuation">:</span> custom<span class="token punctuation">-</span>ca
  <span class="token key atrule">connectivity</span><span class="token punctuation">:</span>
    <span class="token key atrule">replicaSetHorizons</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">"userdb"</span><span class="token punctuation">:</span> <span class="token string">"userdb0.com:27017"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">"userdb"</span><span class="token punctuation">:</span> <span class="token string">"userdb1.com:27017"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">"userdb"</span><span class="token punctuation">:</span> <span class="token string">"userdb2.com:27017"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Tips</strong>: the key of <code>replicaSetHorizons</code>
("userdb") is not that important, just keep all the entries have the
same key string.</p>
<p>Apply <code>userdb.yaml</code>: <pre class="line-numbers language-none"><code class="language-none">$ kubectl apply -f userdb.yaml -n mongodb
mongodb.mongodb.com&#x2F;userdb configured<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<p><img
src="https://coriva.eu.org/images/mongodb/updatingdeploymenttls.png"
alt="Updating UserDB Deployment" /></p>
<p>Updating details: <img
src="https://coriva.eu.org/images/mongodb/updatingdeploymenttlsdetails.png"
alt="Updating Deployment Details" /></p>
<p>The update needs to be excuted via this path:
<code>disabled -&gt; sslAllowed -&gt; sslPreferred -&gt; sslRequired</code>.</p>
<p>The update process takes a long time (~15mins) and pods restart many
times. When update success, <code>TLS</code> option in the
<code>userdb</code> deployment process UI will become
<code>Enabled</code>.</p>
<p>If you <code>kubectl exec</code> to the pod, the certificate is
stored at <code>/mongodb-automation/</code>: <pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">I have no name<span class="token operator">!</span>@userdb-0:/$ <span class="token function">ls</span> <span class="token parameter variable">-l</span> /mongodb-automation/
total <span class="token number">8</span>
lrwxrwxrwx <span class="token number">1</span> <span class="token number">2000</span> root   <span class="token number">45</span> Dec <span class="token number">11</span> 06:25 ca.pem -<span class="token operator">></span> /var/lib/mongodb-automation/secrets/ca/ca-pem
drwxr-xr-x <span class="token number">2</span> <span class="token number">2000</span> root <span class="token number">4096</span> Dec <span class="token number">11</span> 06:25 files
-rw-r--r-- <span class="token number">1</span> <span class="token number">2000</span> root    <span class="token number">3</span> Dec <span class="token number">11</span> 06:25 mongodb-mms-automation-agent.pid
lrwxrwxrwx <span class="token number">1</span> <span class="token number">2000</span> root   <span class="token number">54</span> Dec <span class="token number">11</span> 06:25 server.pem -<span class="token operator">></span> /var/lib/mongodb-automation/secrets/certs/userdb-0-pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2
id="error-calling-computestate-error-dialing-to-connparams-error-checking-if-rs-member-is-up-error"><code>Error calling ComputeState</code>,
<code>Error dialing to connParams</code>,
<code>Error checking if rs member is up</code> Error</h2>
<p>If update failed and the Agent Log shows error: <pre class="line-numbers language-none"><code class="language-none">&lt;userdb-1&gt; [03:29:59.660] Failed to compute states : &lt;userdb-1&gt; [03:29:59.660] Error calling ComputeState : &lt;userdb-1&gt; [03:29:59.660] Error getting fickle state for current state : &lt;userdb-1&gt; [03:29:59.660] Error checking if rs member &#x3D; userdb-0.userdb-svc.mongodb.svc.cluster.local:27017 is up : &lt;userdb-1&gt; [03:29:59.660] Error executing WithClientFor() for cp&#x3D;userdb-0.userdb-svc.mongodb.svc.cluster.local:27017 (local&#x3D;false) connec tMode&#x3D;SingleConnect : &lt;userdb-1&gt; [03:29:59.660] Error checking out client (0x0) for connParam&#x3D;userdb-0.userdb-svc.mongodb.svc.cluster.local:27017 (local&#x3D;false) connectMode&#x3D;SingleConnect : [03:29:59.659] Error dialing to connParams&#x3D;userdb-0.userdb-svc.mongodb.svc.cluster.local:27017 (local&#x3D;false): tried 4 identities, but none of them worked. They were (__system@local[[MONGODB-CR&#x2F;SCRAM-SHA-1 SCRAM-SHA-256]][1024], __system@local[[MONGODB-CR&#x2F;SCRAM-SHA-1 SCRAM-SHA-256]][1024], mms-automation@admin[[MONGODB-CR&#x2F;SCRAM-SHA-1]][24], )

Error checking out client (0x0) for connParam&#x3D;userdb-0.userdb-svc.mongodb.svc.cluster.local:27017 (local&#x3D;false) connectMode&#x3D;SingleConnect : [03:32:57.470] Error dialing to connParams&#x3D;userdb-0.userdb-svc.mongodb.svc.cluster.local:27017 (local&#x3D;false): tried 4 identities, but none of them worked. They were (__system@local[[MONGODB-CR&#x2F;SCRAM-SHA-1 SCRAM-SHA-256]][1024], __system@local[[MONGODB-CR&#x2F;SCRAM-SHA-1 SCRAM-SHA-256]][1024], mms-automation@admin[[MONGODB-CR&#x2F;SCRAM-SHA-1]][24], )

Error getting client ready for conn params &#x3D; userdb-0.userdb-svc.mongodb.svc.cluster.local:27017 (local&#x3D;false). Informing all requests and disposing of client (0x0). requests&#x3D;[ 0xc001e58780 ] : [03:32:57.470] Error dialing to connParams&#x3D;userdb-0.userdb-svc.mongodb.svc.cluster.local:27017 (local&#x3D;false): tried 4 identities, but none of them worked. They were (__system@local[[MONGODB-CR&#x2F;SCRAM-SHA-1 SCRAM-SHA-256]][1024], __system@local[[MONGODB-CR&#x2F;SCRAM-SHA-1 SCRAM-SHA-256]][1024], mms-automation@admin[[MONGODB-CR&#x2F;SCRAM-SHA-1]][24], )<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>It's high likely that the certficate is not correct, though the error
message has none of certficate's business. Double check that the
certificate contains <code>internal endpoints</code>:
userdb-0.userdb-svc.mongodb.svc.cluster.local. Get back to the previous
step <a href="/2020/12/19/mongodbomselfsignedcertificates.en/">Openssl
Generates Self-signed Certificates</a>, modify
<code>[ alt_names ]</code> in <code>userdb&lt;X&gt;.cnf</code> and
recreate the server certificates.</p>
<h1 id="conect-to-userdb">Conect to UserDB</h1>
<p>Now connect to user database via mongo shell, here is a trick that
<code>tlsCAFile</code> is not supported in the connection string, you
must specify it by the <a
target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/connection-string/">command-line
option</a>: <pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ mongo mongodb://userdb0.com:27017,userdb1.com:27017,userdb2.com:27017/ <span class="token parameter variable">--tls</span> <span class="token parameter variable">--tlsCAFile</span> rootca.crt
MongoDB shell version v4.4.2
connecting to: mongodb://userdb0.com:27017,userdb1.com:27017,userdb2.com:27017/?compressors<span class="token operator">=</span>disabled<span class="token operator">&amp;</span><span class="token assign-left variable">gssapiServiceName</span><span class="token operator">=</span>mongodb
Implicit session: session <span class="token punctuation">&#123;</span> <span class="token string">"id"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"fcbaa78a-21dd-472f-a84f-bf3435bf9088"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
MongoDB server version: <span class="token number">4.2</span>.2
WARNING: shell and server versions <span class="token keyword">do</span> not match
---
The server generated these startup warnings when booting:
<span class="token number">2020</span>-12-11T06:25:58.940+0000 I  STORAGE  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span>
<span class="token number">2020</span>-12-11T06:25:58.940+0000 I  STORAGE  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine
<span class="token number">2020</span>-12-11T06:25:58.940+0000 I  STORAGE  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> **          See http://dochub.mongodb.org/core/prodnotes-filesystem
<span class="token number">2020</span>-12-11T06:26:00.201+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span>
<span class="token number">2020</span>-12-11T06:26:00.201+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> ** WARNING: Access control is not enabled <span class="token keyword">for</span> the database.
<span class="token number">2020</span>-12-11T06:26:00.201+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> **          Read and <span class="token function">write</span> access to data and configuration is unrestricted.
<span class="token number">2020</span>-12-11T06:26:00.201+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span>
---
MongoDB Enterprise userdb:PRIMARY<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> The prompt's <code>PRIMARY</code> indicates
that the cluster works fine! Run <code>rs.conf()</code> and check the
<code>horizons</code>: <pre class="line-numbers language-none"><code class="language-none">MongoDB Enterprise userdb:PRIMARY&gt; rs.conf()
&#123;
        &quot;_id&quot; : &quot;userdb&quot;,
        &quot;version&quot; : 2,
        &quot;protocolVersion&quot; : NumberLong(1),
        &quot;writeConcernMajorityJournalDefault&quot; : true,
        &quot;members&quot; : [
                &#123;
                        &quot;_id&quot; : 0,
                        &quot;host&quot; : &quot;userdb-0.userdb-svc.mongodb.svc.cluster.local:27017&quot;,
...
                        &quot;horizons&quot; : &#123;
                                &quot;userdb&quot; : &quot;userdb0.com:27017&quot;
                        &#125;,
                        &quot;slaveDelay&quot; : NumberLong(0),
                        &quot;votes&quot; : 1
                &#125;,
                &#123;
                        &quot;_id&quot; : 1,
                        &quot;host&quot; : &quot;userdb-1.userdb-svc.mongodb.svc.cluster.local:27017&quot;,
...
                        &quot;horizons&quot; : &#123;
                                &quot;userdb&quot; : &quot;userdb1.com:27017&quot;
                        &#125;,
                        &quot;slaveDelay&quot; : NumberLong(0),
                        &quot;votes&quot; : 1
                &#125;,
                &#123;
                        &quot;_id&quot; : 2,
                        &quot;host&quot; : &quot;userdb-2.userdb-svc.mongodb.svc.cluster.local:27017&quot;,
...
                        &quot;horizons&quot; : &#123;
                                &quot;userdb&quot; : &quot;userdb2.com:27017&quot;
                        &#125;,
                        &quot;slaveDelay&quot; : NumberLong(0),
                        &quot;votes&quot; : 1
                &#125;
        ],
...
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h1 id="enable-auth">Enable AUTH</h1>
<p>Enable AUTH after TLS is pretty easy. Just click the
<code>Disabled</code> in the Processes UI and follow the guide. Finally,
click the top <code>review &amp; deploy</code> button.</p>
<p>The final Processes UI: <img
src="https://coriva.eu.org/images/mongodb/userdbreplicasetdone.png"
alt="UserDB Deployment Completed" /></p>
<p>The startup warnings disappear: <pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ mongo mongodb://userdb0.com:27017,userdb1.com:27017,userdb2.com:27017/ <span class="token parameter variable">--tls</span> <span class="token parameter variable">--tlsCAFile</span> rootca.crt
MongoDB shell version v4.4.2
connecting to: mongodb://userdb0.com:27017,userdb1.com:27017,userdb2.com:27017/?compressors<span class="token operator">=</span>disabled<span class="token operator">&amp;</span><span class="token assign-left variable">gssapiServiceName</span><span class="token operator">=</span>mongodb
Implicit session: session <span class="token punctuation">&#123;</span> <span class="token string">"id"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"5063023a-b76d-4d03-923f-18332e2e7cc9"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
MongoDB server version: <span class="token number">4.2</span>.2
WARNING: shell and server versions <span class="token keyword">do</span> not match
MongoDB Enterprise userdb:PRIMARY<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h1 id="summary">Summary</h1>
<p>This series describe how to deploy MongoDB Ops Manager, and use
MongoDB Kubernetes Operator to build a MongoDB ReplicaSet. If you found
errors please feel free to leave comments below.</p>
<p>Thanks for your time!</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MongoDB/" rel="tag"># MongoDB</a>
              <a href="/tags/MongoDB-Ops-Manager/" rel="tag"># MongoDB Ops Manager</a>
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
              <a href="/tags/TLS/" rel="tag"># TLS</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/12/19/mongodbomselfsignedcertificates.en/" rel="prev" title="MongoDB Cluster In Kubernetes(4): Openssl Generates Self-signed Certificates">
                  <i class="fa fa-chevron-left"></i> MongoDB Cluster In Kubernetes(4): Openssl Generates Self-signed Certificates
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/12/26/mongodbomcreateshardedcluster/" rel="next" title="部署Kubernetes MongoDB Sharded Cluster">
                  部署Kubernetes MongoDB Sharded Cluster <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">finisky</span>
</div><div><span class="post-meta-item-icon"><i class="far fa-eye"></i></span><span><a href="https://finicounter.eu.org/" target="_blank">Total Views</a>:</span><span id="finicount_views" style="display:inline;padding-left:5px;"></span><div> <script async src="//finicounter.eu.org/finicounter.js"></script>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/finisky" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  




  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"en","enable":true,"serverURL":"https://comments.finisky.eu.org","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":true,"pageSize":10,"el":"#waline","comment":true,"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","path":"/2020/12/19/mongodbomtlsauth.en/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>


        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body>
</html>
