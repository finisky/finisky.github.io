<!DOCTYPE html>
<html lang="zh-CN">
<head><!-- hexo injector head_begin start --><!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-K4DEGPDYSW"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag("js", new Date()); gtag("config", "G-K4DEGPDYSW"); </script><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">
  <meta name="google-site-verification" content="oFhcvcGsjsTY5AFUaI-ezbn7-bel9NrdUNpeQfwZSwI">
  <meta name="msvalidate.01" content="F8E2F274161B653649F8818FD127CE87">
  <meta name="yandex-verification" content="ff1f79abcbf80d7e">
  <meta name="baidu-site-verification" content="code-nNL5JO7sPl">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"finisky.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
<meta property="og:type" content="website">
<meta property="og:title" content="Finisky Garden">
<meta property="og:url" content="https://finisky.github.io/index.html">
<meta property="og:site_name" content="Finisky Garden">
<meta property="og:description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="finisky">
<meta property="article:tag" content="NLP, 机器学习, 软件工程, 系统设计, 互联网, 产品设计, Machine Learning, Product Design, Software Engineerning">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://finisky.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Finisky Garden</title>
  







<link rel="dns-prefetch" href="https://comments.finisky.eu.org">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script type="text/javascript"> function downloadJsAtOnload() { setTimeout(function downloadJs() { var element = document.createElement("script"); element.setAttribute("data-ad-client", "ca-pub-2660281922577700"); element.async = true; element.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"; document.body.appendChild(element); }, 5000); }; if (window.addEventListener) window.addEventListener("load", downloadJsAtOnload, false); else if (window.attachEvent) window.attachEvent("onload", downloadJsAtOnload); else window.onload = downloadJsAtOnload; </script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Finisky Garden" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Finisky Garden</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">NLP, 软件工程, 产品设计</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-nlp"><a href="/tags/NLP/" rel="section"><i class="fa fa-language fa-fw"></i>NLP</a></li><li class="menu-item menu-item-mongodb"><a href="/categories/MongoDB/" rel="section"><i class="fas fa-database fa-fw"></i>MongoDB</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-友链"><a href="/links/" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="finisky"
      src="/images/qrcode.jpg">
  <p class="site-author-name" itemprop="name">扫码关注公众号</p>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">251</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/en/building-large-scale-social-network-graphs-with-mongodb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/en/building-large-scale-social-network-graphs-with-mongodb/" class="post-title-link" itemprop="url">Building Large-Scale Social Network Graphs with MongoDB</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-11-05 00:59:12 / 修改时间：01:29:24" itemprop="dateCreated datePublished" datetime="2024-11-05T00:59:12+08:00">2024-11-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/en/building-large-scale-social-network-graphs-with-mongodb/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/en/building-large-scale-social-network-graphs-with-mongodb/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/en/building-large-scale-social-network-graphs-with-mongodb/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Nowadays, many popular apps incorporate social network features, such
as Twitter, WhatsApp, and Facebook. These platforms need to scale to
accommodate billions of users (graph nodes), which is no small feat.
Building and maintaining a scalable social network infrastructure
requires careful planning and strategic data modeling. In fact,
specialized social networking applications like Facebook have dedicated
teams focusing solely on optimizing their performance to the highest
level. However, for smaller apps or startup projects looking to add
social networking capabilities, creating a full team to handle such
architecture is often impractical and unnecessary.</p>
<p>So, is it possible to build a high-performance, scalable social
network using the right data modeling and storage solutions? The answer
is yes. Early versions of Facebook used MySQL as the underlying storage
to construct their social network, but today we have more advanced and
efficient storage options available: MongoDB.</p>
<h1 id="problem-description-and-challenges">Problem Description and
Challenges</h1>
<p>To begin, let’s outline and simplify the problem. Our goal is to
build a social network where any user can follow other users. Each user
should be able to view whom they are following, who follows them, and
the counts for both. For example, on Twitter, Elon Musk’s profile shows
that he follows 800 people and has 202.8M followers.</p>
<p><img
src="https://coriva.eu.org/images/followmodeling_musk.png" /></p>
<p>By opening his followers' page, you can see detailed information
about each follower, such as Dr. Jordan B. Peterson and others.</p>
<p><img
src="https://coriva.eu.org/images/followmodeling_musk.png" /></p>
<p>After simplifying the problem, we need to support the following core
functionalities: following and unfollowing users, viewing the count of
followers and following, and viewing the list of followers or the people
a user follows. It's worth noting that since many celebrities have an
enormous number of followers, Twitter only allows viewing a limited
number of follower profiles.</p>
<p>While these features may seem straightforward, scaling them to handle
billions of users presents significant challenges. Reading and updating
the social relationships between users becomes an extremely frequent
operation, raising the question: can the data model and underlying
storage support such massive data volume and the high QPS (queries per
second) required for a high-concurrency environment?</p>
<h1 id="data-modeling-and-scalability">Data Modeling and
Scalability</h1>
<p>To achieve the above functionalities, data modeling is the key. The
following six APIs are needed:</p>
<pre class="line-numbers language-none"><code class="language-none">api&#x2F;Follow
api&#x2F;Unfollow
api&#x2F;GetFollowers
api&#x2F;GetFollowings
api&#x2F;GetFollowerCount
api&#x2F;GetFollowingCount<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Assuming each user is represented by a UUID, a straightforward data
modeling approach would be to store two records for each relationship.
Each record represents a directional relationship, such as:</p>
<table>
<thead>
<tr class="header">
<th>SrcUuid</th>
<th>DstUuid</th>
<th>Status</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>u1</td>
<td>u2</td>
<td>Follow</td>
<td>u1关注了u2</td>
</tr>
<tr class="even">
<td>u2</td>
<td>u1</td>
<td>Follow</td>
<td>u2关注了u1</td>
</tr>
<tr class="odd">
<td>u3</td>
<td>u4</td>
<td>Follow</td>
<td>u3关注了u4</td>
</tr>
</tbody>
</table>
<p>Since <strong>u1</strong> follows <strong>u2</strong>, and
<strong>u2</strong> follows <strong>u1</strong>, <strong>u1</strong> and
<strong>u2</strong> have a mutual following relationship. On the other
hand, if <strong>u3</strong> follows <strong>u4</strong> and there's
only one record, then it represents a one-way following
relationship.</p>
<p>With this type of data modeling, implementing follow and unfollow
operations becomes straightforward, as it only involves inserting or
deleting a record. Retrieving a user's followers can be accomplished
using a query like <code>DstUuid == x</code>, while counting the number
of followers can be done with <code>Count(DstUuid == x)</code>. The same
applies for finding who a user is following.</p>
<p>Thus, a single table can be used to store the relationship data
between users, defined as follows:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FollowEntry</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SrcUuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DstUuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">FollowStatus</span> Status <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> UpdateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">FollowStatus</span>
<span class="token punctuation">&#123;</span>
    None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    Follow <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>How Can This Data Model Scale to Millions of Users?</p>
<p>The answer lies in leveraging <strong>sharding</strong> and
<strong>replicaset nodes</strong> for scalability. Sharding enhances
write capabilities by distributing data across multiple shards, while
adding replicaset nodes increases read capacity. This scaling approach
is transparent to the upper-layer application, unlike MySQL's sharding
and partitioning, which can impose constraints on application queries.
This is one of the advantages of using MongoDB.</p>
<h1 id="system-implementation">System Implementation</h1>
<p>In this section, we will implement each API and identify the required
indexes and shard keys based on actual read patterns.</p>
<h2 id="follow-api">Follow API</h2>
<p>The implementation of the Follow API is straightforward: it involves
an upsert operation to insert or update a follow record, regardless of
whether the record previously existed or its status:</p>
<h2 id="follow-api-1">Follow API</h2>
<p>The implementation of the Follow API is quite simple. It involves
performing an upsert operation to insert or update a follow record,
regardless of whether the record already exists or its previous
status:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">FollowAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> srcUuid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> dstUuid<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>FollowEntry<span class="token operator">></span><span class="token punctuation">.</span>Update
                    <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>UpdateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>SrcUuid<span class="token punctuation">,</span> srcUuid<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid<span class="token punctuation">,</span> dstUuid<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> option <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UpdateOptions</span> <span class="token punctuation">&#123;</span> IsUpsert <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">UpdateOneAsync</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>SrcUuid <span class="token operator">==</span> srcUuid <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> dstUuid<span class="token punctuation">,</span> update<span class="token punctuation">,</span> option<span class="token punctuation">,</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The implementation of the Unfollow API is similar to the Follow API,
with the only difference being that the <code>FollowStatus</code> is set
to <code>None</code> to indicate that the user has unfollowed.</p>
<p>Both the Follow and Unfollow APIs require an index:
<code>(SrcUuid, DstUuid)</code>.</p>
<h2 id="getfollowers-api">GetFollowers API</h2>
<p>The implementation of the GetFollowers API needs to consider
pagination and a maximum return limit. Here’s a straightforward approach
that returns the earliest <code>n</code> followers based on their
creation timestamp:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>FollowEntry<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetFollowersAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> uuid <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Status <span class="token operator">==</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SortBy</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The implementation of the GetFollowings API is similar to the
GetFollowers API: Simply replace <code>DstUuid</code> with
<code>SrcUuid</code>.</p>
<p>These two APIs require indexes:
<code>(DstUuid, FlowStatus, CreateTime)</code> and
<code>(SrcUuid, FlowStatus, CreateTime)</code>. The inclusion of the low
cardinality field <code>FollowStatus</code> in the indexes is beneficial
because, over time, there may be many unfollow entries present in the
dataset. By indexing this field, query performance can improve,
especially when filtering for active relationships. However, it's
important to choose indexes based on the specific application scenarios,
as unnecessary indexes can lead to increased overhead during write
operations.</p>
<h2 id="getfollowercount-api">GetFollowerCount API</h2>
<p>The implementation of the GetFollowerCount API:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">long</span><span class="token punctuation">></span></span> <span class="token function">GetFollowerCountAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">CountDocumentsAsync</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> uuid
                                                    <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Status <span class="token operator">==</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The implementation of the GetFollowingCount API is similar. Simply
replace <code>DstUuid</code> with <code>SrcUuid</code>.</p>
<p>These two APIs can reuse the indexes established for the GetFollowers
and GetFollowings APIs.</p>
<h2 id="indexes-and-shard-keys">Indexes and Shard Keys</h2>
<p>Based on the above implementations and considering the leftmost
prefix matching principle, we need three indexes:</p>
<ul>
<li>(SrcUuid, DstUuid)</li>
<li>(DstUuid, FlowStatus, CreateTime)</li>
<li>(SrcUuid, FlowStatus, CreateTime)</li>
</ul>
<p>At the same time, these indexes can also support APIs such as
"GetTwoUserRelationship()", which will not be elaborated on further.</p>
<p>Considering that user IDs use UUIDs, which are already uniformly
distributed, there is no need to use hashed sharding. We only need to
consider which is more commonly used in the application context:
GetFollowers or GetFollowings. Assuming GetFollowings is more commonly
used, we can choose <code>SrcUuid</code> as the shard key. This ensures
that all users followed by a given user reside in the same shard,
improving read efficiency.</p>
<p>Sharding can be executed in the MongoDB shell with:
<code>sh.shardCollection("Test.Test", &#123; "SrcUuid": 1 &#125;)</code></p>
<p>Sharded clusters can significantly increase the upper limits of the
system, and they do not require code modifications; the capacity of the
system can be expanded online.</p>
<h1 id="test-code">Test Code</h1>
<p>Randomly generate 1,000 users and 2,000 follow relationships, and
print the follower information for one user who has more than 5
followers.</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> userList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Generate 1000 users</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        userList<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Generate 2000 relationships</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> src <span class="token operator">=</span> userList<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dst <span class="token operator">=</span> userList<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">==</span> dst<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">FollowAsync</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> user <span class="token keyword">in</span> userList<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> followerCount <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetFollowerCountAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>followerCount <span class="token operator">></span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> followers <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetFollowersAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> entry <span class="token keyword">in</span> followers<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">entry<span class="token punctuation">.</span>SrcUuid</span><span class="token punctuation">&#125;</span></span><span class="token string"> follows </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">user</span><span class="token punctuation">&#125;</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">entry<span class="token punctuation">.</span>CreateTime</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">user</span><span class="token punctuation">&#125;</span></span><span class="token string"> followers: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">followerCount</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The results:</p>
<blockquote>
<p>7289820430DA4BCD930CFE1067A3DC89 follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:41:57 PM
F2E95841840C45B496C6629181DD2C77 follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:42:05 PM
7FFB5DE3E3A94AFF8AB487EA82DA2A68 follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:42:07 PM
AE9D38F638C145848997F2E0E8BF62DF follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:42:09 PM
4E15001E616E441395FBC04CA0F3F36E follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:42:10 PM
5798C300560A4C09B35F7B48AF57ACF5 followers: 8 Done</p>
</blockquote>
<p>Connect to the database deployed on MongoDB Atlas using MongoDB
Compass:</p>
<p><img
src="https://coriva.eu.org/images/followmodeling_compass.png" /></p>
<h1 id="discussion-and-optimization">Discussion and Optimization</h1>
<p>The social relationship data modeling introduced in this article is a
simplified design aimed at demonstrating how to utilize MongoDB's
sharded cluster to build a large-scale social network graph. In a real
production environment, there are several issues that need to be
considered and optimized:</p>
<ul>
<li><p>Write-heavy or Read-heavy: Here, we use user IDs to represent
users, concealing user information. The actual implementation would
require APIs for bulk reading of user information. If user details are
included in the <code>FollowEntry</code>, it would improve read
efficiency but significantly lower update efficiency (Write-heavy). The
current design transitions a write-heavy model into a read-heavy model
by fetching the latest user information in real-time.</p></li>
<li><p>Caching: Although MongoDB offers excellent performance, front-end
caching (such as Redis) is still essential and can greatly enhance
system throughput. This is particularly important for APIs like
<code>GetFollowersCount</code>, where caching an approximate count is
crucial for efficiency.</p></li>
<li><p>Support for Complex Business Logic: The scenarios for platforms
like Twitter are much more complex than those described here. They must
consider not only social relationships but also the read/write
interactions of each tweet and the integration with recommendation
systems. Due to space limitations, a deeper discussion on this topic is
not provided.</p></li>
</ul>
<p>Load testing confirms that the optimized social relationship system
can support 100,000+ or even higher QPS, demonstrating excellent
performance and throughput. This makes it very suitable for startups
looking to rapidly develop and iterate their products.</p>
<h1 id="full-demo">Full Demo</h1>
<p>Fill the <code>ConnectionString</code>:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">MongoDB<span class="token punctuation">.</span>Bson<span class="token punctuation">.</span>Serialization<span class="token punctuation">.</span>Conventions</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">MongoDB<span class="token punctuation">.</span>Driver</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">MongoTest</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RelModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            model<span class="token punctuation">.</span><span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FollowEntry</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SrcUuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DstUuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">FollowStatus</span> Status <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> UpdateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">FollowStatus</span>
    <span class="token punctuation">&#123;</span>
        None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        Follow <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        Deleted <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RelModel</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMongoClient</span> _mongoClient<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMongoCollection<span class="token punctuation">&lt;</span>FollowEntry<span class="token punctuation">></span></span> _followCollection<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> DatabaseName <span class="token operator">=</span> <span class="token string">"Test"</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> CollectionName <span class="token operator">=</span> <span class="token string">"Test"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> ConnectionString <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">RelModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _mongoClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MongoClient</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> database <span class="token operator">=</span> _mongoClient<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span>DatabaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> ignoreExtraElementsConvention <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConventionPack</span> <span class="token punctuation">&#123;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IgnoreExtraElementsConvention</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            ConventionRegistry<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">"IgnoreExtraElements"</span><span class="token punctuation">,</span> ignoreExtraElementsConvention<span class="token punctuation">,</span> type <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _followCollection <span class="token operator">=</span> database<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCollection</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>FollowEntry<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>CollectionName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> userList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Generate 1000 users</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                userList<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Generate 2000 relationships</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> src <span class="token operator">=</span> userList<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> dst <span class="token operator">=</span> userList<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">==</span> dst<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> <span class="token function">FollowAsync</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> user <span class="token keyword">in</span> userList<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> followerCount <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetFollowerCountAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>followerCount <span class="token operator">></span> <span class="token number">5</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> followers <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetFollowersAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> entry <span class="token keyword">in</span> followers<span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">entry<span class="token punctuation">.</span>SrcUuid</span><span class="token punctuation">&#125;</span></span><span class="token string"> follows </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">user</span><span class="token punctuation">&#125;</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">entry<span class="token punctuation">.</span>CreateTime</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">user</span><span class="token punctuation">&#125;</span></span><span class="token string"> followers: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">followerCount</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">FollowAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> srcUuid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> dstUuid<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>FollowEntry<span class="token operator">></span><span class="token punctuation">.</span>Update
                            <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>UpdateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>SrcUuid<span class="token punctuation">,</span> srcUuid<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid<span class="token punctuation">,</span> dstUuid<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> option <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UpdateOptions</span> <span class="token punctuation">&#123;</span> IsUpsert <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">UpdateOneAsync</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>SrcUuid <span class="token operator">==</span> srcUuid <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> dstUuid<span class="token punctuation">,</span> update<span class="token punctuation">,</span> option<span class="token punctuation">,</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>FollowEntry<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetFollowersAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> uuid <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Status <span class="token operator">==</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SortBy</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">long</span><span class="token punctuation">></span></span> <span class="token function">GetFollowerCountAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">CountDocumentsAsync</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> uuid
                                                            <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Status <span class="token operator">==</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/building-large-scale-social-network-graphs-with-mongodb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/building-large-scale-social-network-graphs-with-mongodb/" class="post-title-link" itemprop="url">用MongoDB构建大规模社交网络关系链</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-11-04 21:59:48" itemprop="dateCreated datePublished" datetime="2024-11-04T21:59:48+08:00">2024-11-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-11-05 01:29:24" itemprop="dateModified" datetime="2024-11-05T01:29:24+08:00">2024-11-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/building-large-scale-social-network-graphs-with-mongodb/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/building-large-scale-social-network-graphs-with-mongodb/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/building-large-scale-social-network-graphs-with-mongodb/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>如今许多App都涉及社交网络，如 Twitter、WhatsApp 和
Facebook。这些平台必须扩展以处理数十亿用户（图节点），这并非易事。构建和维护一个可扩展的社交网络基础设施需要仔细的规划和战略性的数据建模。实际上，像Facebook这样专业的社交网络应用有专门的团队来做这块内容，对其性能进行极致的优化。但对于许多希望加入社交网络功能的小型App，如一个创业公司项目，建立一个团队来做这样的架构显然是不现实也没有必要的。</p>
<p>那么，利用合适的数据建模和存储能否构建一个高性能易扩展的社交网络？答案是肯定的。早期的Facebook使用mysql作为底层存储来构建社交网络，但今天我们可以有更好更高效的存储选择：MongoDB。</p>
<h1 id="问题描述与挑战">问题描述与挑战</h1>
<p>首先，我们来描述和简化一下问题。我们希望构建一个社交网络，其中任意用户都可以关注其他用户，每个用户可以显示关注了哪些人，被关注了哪些人，以及关注和被关注数。例如，Twitter上Elon
Musk的页面显示他关注了800人，同时有202.8M的粉丝。</p>
<p><img
src="https://coriva.eu.org/images/followmodeling_musk.png" /></p>
<p>点开他的粉丝页面，可以看到每个粉丝具体的信息，如Dr Jordan B
Peterson等。</p>
<p><img
src="https://coriva.eu.org/images/followmodeling_musk.png" /></p>
<p>将问题简化后，我们需要支持如下基本功能：关注和取关，查看关注和粉丝数，查看关注的人或粉丝。注意，由于许多名人拥有大量的粉丝，所以Twitter仅支持查看有限个数的粉丝信息。</p>
<p>这些功能虽然看起来很简单，但将这些功能扩展至数十亿用户规模之后就出现了挑战，读取和更新用户之间的社交关系是个非常频繁的操作，数据建模与底层存储是否可以支撑如此之大的数据规模和高并发场景的QPS？</p>
<h1 id="数据建模与可扩展性">数据建模与可扩展性</h1>
<p>为了完成上述功能，数据建模是问题的关键。需要如下6个API：</p>
<pre class="line-numbers language-none"><code class="language-none">api&#x2F;Follow
api&#x2F;Unfollow
api&#x2F;GetFollowers
api&#x2F;GetFollowings
api&#x2F;GetFollowerCount
api&#x2F;GetFollowingCount<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>假设每个用户用一个Uuid进行表示，显然，一种直接的数据建模方式为存储两条记录，每条记录代表一个关系，如：</p>
<table>
<thead>
<tr class="header">
<th>SrcUuid</th>
<th>DstUuid</th>
<th>Status</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>u1</td>
<td>u2</td>
<td>Follow</td>
<td>u1关注了u2</td>
</tr>
<tr class="even">
<td>u2</td>
<td>u1</td>
<td>Follow</td>
<td>u2关注了u1</td>
</tr>
<tr class="odd">
<td>u3</td>
<td>u4</td>
<td>Follow</td>
<td>u3关注了u4</td>
</tr>
</tbody>
</table>
<p>由于u1关注了u2，同时u2也关注了u1，于是u1和u2是互相关注的关系；而u3关注了u4，仅有一条记录，因此只是单向关注关系。</p>
<p>对于这样的数据建模，关注和取关操作的实现也较为容易，插入或删除一条记录即可。获取关注者可以由<code>DstUuid == x</code>查询实现，获取关注者数可由<code>Count(DstUuid == x)</code>查询实现，被关注者亦然。</p>
<p>因此，可以选择使用一张表来存储用户之间的关系数据，数据定义如下：</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FollowEntry</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SrcUuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DstUuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">FollowStatus</span> Status <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> UpdateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">FollowStatus</span>
<span class="token punctuation">&#123;</span>
    None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    Follow <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样的数据建模如何能扩展到海量用户？答案是利用分片和增加副本集节点进行扩展，分片可以增加写入能力，而增加副本集节点可以增加读取能力。这样的扩展对上层应用是透明的，不必像mysql的分库分表操作，对上层应用查询会有一定的限制。这也是MongoDB的优势之一。</p>
<h1 id="系统实现">系统实现</h1>
<p>这里具体实现各个API，并通过实际的读取方式来确定所需要的索引和片键。</p>
<h2 id="follow-api">Follow API</h2>
<p>Follow
API的实现很简单，Upsert一条关注记录即可，不论之前该记录是否存在，或状态如何：</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">FollowAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> srcUuid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> dstUuid<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>FollowEntry<span class="token operator">></span><span class="token punctuation">.</span>Update
                    <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>UpdateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>SrcUuid<span class="token punctuation">,</span> srcUuid<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid<span class="token punctuation">,</span> dstUuid<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> option <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UpdateOptions</span> <span class="token punctuation">&#123;</span> IsUpsert <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">UpdateOneAsync</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>SrcUuid <span class="token operator">==</span> srcUuid <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> dstUuid<span class="token punctuation">,</span> update<span class="token punctuation">,</span> option<span class="token punctuation">,</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Unfollow
API的实现类似，仅需要将FollowStatus置为<code>None</code>即可。</p>
<p>这两个API需要索引：(SrcUuid, DstUuid)。</p>
<h2 id="getfollowers-api">GetFollowers API</h2>
<p>GetFollowers
API的实现需要考虑分页和最大返回条数限制，这里采用一种较为简捷的实现，返回创建时间最早的前n个Follower:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>FollowEntry<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetFollowersAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> uuid <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Status <span class="token operator">==</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SortBy</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>GetFollowings API的实现类似，仅需要将DstUuid 替换为SrcUuid即可。</p>
<p>这两个API需要索引：(DstUuid, FlowStatus, CreateTime) 和 (SrcUuid,
FlowStatus, CreateTime)。将low cardinality field
FollowStatus加入索引的原因在于随着时间推移，可能有许多取关的条目存在，加入之后读取效率能稍微高一些，可以根据应用场景进行选择。</p>
<h2 id="getfollowercount-api">GetFollowerCount API</h2>
<p>GetFollowerCount API的实现也很直观：</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">long</span><span class="token punctuation">></span></span> <span class="token function">GetFollowerCountAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">CountDocumentsAsync</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> uuid
                                                    <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Status <span class="token operator">==</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>GetFollowingCount API的实现类似，仅需要将DstUuid
替换为SrcUuid即可。</p>
<p>这两个API可以复用GetFollowers/GetFollowings的索引。</p>
<h2 id="索引与片键">索引与片键</h2>
<p>根据上述API的实现，考虑到索引的前缀复用属性，共需要三个索引：</p>
<ul>
<li>(SrcUuid, DstUuid)</li>
<li>(DstUuid, FlowStatus, CreateTime)</li>
<li>(SrcUuid, FlowStatus, CreateTime)</li>
</ul>
<p>同时，这些索引也可以满足如"GetTwoUserRelationship()"这样的API，不再赘述。</p>
<p>考虑到用户Id使用Uuid，已经是均匀分布，故不必采用hashed
sharding的方式，仅需考虑应用场景中GetFollowers与GetFollowings哪个更常用即可，假设GetFollowings更常用，则可以选择<code>SrcUuid</code>作为分片的片键，这样可以保证一个用户关注的所有人都存在相同的分片中，读取效率更高。</p>
<p>分片可在mongoshell中执行：<code>sh.shardCollection("Test.Test", &#123; "SrcUuid": 1&#125;)</code></p>
<p>分片集群可以极大地扩展系统的上限，并且不需要修改代码，可以在线完成系统容量的扩展。</p>
<h1 id="测试代码">测试代码</h1>
<p>随机生成1000个用户和2000个关注关系，并打印出粉丝大于5的一个用户粉丝信息：</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> userList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Generate 1000 users</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        userList<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Generate 2000 relationships</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> src <span class="token operator">=</span> userList<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dst <span class="token operator">=</span> userList<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">==</span> dst<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">FollowAsync</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> user <span class="token keyword">in</span> userList<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> followerCount <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetFollowerCountAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>followerCount <span class="token operator">></span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> followers <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetFollowersAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> entry <span class="token keyword">in</span> followers<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">entry<span class="token punctuation">.</span>SrcUuid</span><span class="token punctuation">&#125;</span></span><span class="token string"> follows </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">user</span><span class="token punctuation">&#125;</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">entry<span class="token punctuation">.</span>CreateTime</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">user</span><span class="token punctuation">&#125;</span></span><span class="token string"> followers: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">followerCount</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果如下：</p>
<blockquote>
<p>7289820430DA4BCD930CFE1067A3DC89 follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:41:57 PM
F2E95841840C45B496C6629181DD2C77 follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:42:05 PM
7FFB5DE3E3A94AFF8AB487EA82DA2A68 follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:42:07 PM
AE9D38F638C145848997F2E0E8BF62DF follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:42:09 PM
4E15001E616E441395FBC04CA0F3F36E follows
5798C300560A4C09B35F7B48AF57ACF5 at 11/4/2024 1:42:10 PM
5798C300560A4C09B35F7B48AF57ACF5 followers: 8 Done</p>
</blockquote>
<p>使用MongoDB Compass连接部署在MongoDB Atlas上的DB： <img
src="https://coriva.eu.org/images/followmodeling_compass.png" /></p>
<h1 id="讨论与优化">讨论与优化</h1>
<p>本文所介绍的社交关系链数据建模仅是一个简化版本的设计，旨在演示如何利用MongoDB的分片集群实现大规模社交网络图的构建。如果涉及实际生产环境，还有许多问题需要考虑和优化：</p>
<ul>
<li>Write-heavy or
Read-heavy：这里采用userid代表用户，隐去了用户信息，实际实现需要批量读取用户信息的API。如果在FollowEntry中加入了用户信息，虽然提高了读取效率，但更新效率非常低（Write-heavy）。此处的设计是将write-heavy模式转换成了read-heavy模式，实时拉取用户的最新信息。</li>
<li>缓存：虽然MongoDB的性能极佳，但前置缓存（如Redis）依然必要，可以大幅提升系统吞吐率。尤其是对于GetFollowersCount这样的API，缓存展示一个约数对于效率提升至关重要。</li>
<li>复杂业务支持：Twitter的场景比这里复杂很多，不仅要考虑社交关系，更要考虑每个推文的读写与推荐系统的结合，限于篇幅，此处不做深入讨论。</li>
</ul>
<p>压测证实优化后的社交关系系统可以支撑数十万甚至更高的QPS，性能和吞吐率极佳，非常适合初创公司进行产品快速开发迭代。</p>
<h1 id="demo代码">Demo代码</h1>
<p>填充ConnectionString即可：</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">MongoDB<span class="token punctuation">.</span>Bson<span class="token punctuation">.</span>Serialization<span class="token punctuation">.</span>Conventions</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">MongoDB<span class="token punctuation">.</span>Driver</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">MongoTest</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RelModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            model<span class="token punctuation">.</span><span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FollowEntry</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SrcUuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> DstUuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">FollowStatus</span> Status <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> UpdateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">FollowStatus</span>
    <span class="token punctuation">&#123;</span>
        None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        Follow <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        Deleted <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RelModel</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMongoClient</span> _mongoClient<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMongoCollection<span class="token punctuation">&lt;</span>FollowEntry<span class="token punctuation">></span></span> _followCollection<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> DatabaseName <span class="token operator">=</span> <span class="token string">"Test"</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> CollectionName <span class="token operator">=</span> <span class="token string">"Test"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> ConnectionString <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">RelModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _mongoClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MongoClient</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> database <span class="token operator">=</span> _mongoClient<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span>DatabaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> ignoreExtraElementsConvention <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConventionPack</span> <span class="token punctuation">&#123;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IgnoreExtraElementsConvention</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            ConventionRegistry<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">"IgnoreExtraElements"</span><span class="token punctuation">,</span> ignoreExtraElementsConvention<span class="token punctuation">,</span> type <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _followCollection <span class="token operator">=</span> database<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCollection</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>FollowEntry<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>CollectionName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> userList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Generate 1000 users</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                userList<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// Generate 2000 relationships</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> src <span class="token operator">=</span> userList<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> dst <span class="token operator">=</span> userList<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">==</span> dst<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> <span class="token function">FollowAsync</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> user <span class="token keyword">in</span> userList<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> followerCount <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetFollowerCountAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>followerCount <span class="token operator">></span> <span class="token number">5</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> followers <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetFollowersAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> entry <span class="token keyword">in</span> followers<span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">entry<span class="token punctuation">.</span>SrcUuid</span><span class="token punctuation">&#125;</span></span><span class="token string"> follows </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">user</span><span class="token punctuation">&#125;</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">entry<span class="token punctuation">.</span>CreateTime</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">user</span><span class="token punctuation">&#125;</span></span><span class="token string"> followers: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">followerCount</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">FollowAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> srcUuid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> dstUuid<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>FollowEntry<span class="token operator">></span><span class="token punctuation">.</span>Update
                            <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>UpdateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>SrcUuid<span class="token punctuation">,</span> srcUuid<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid<span class="token punctuation">,</span> dstUuid<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">SetOnInsert</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> option <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UpdateOptions</span> <span class="token punctuation">&#123;</span> IsUpsert <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">UpdateOneAsync</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>SrcUuid <span class="token operator">==</span> srcUuid <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> dstUuid<span class="token punctuation">,</span> update<span class="token punctuation">,</span> option<span class="token punctuation">,</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>FollowEntry<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetFollowersAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> uuid <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Status <span class="token operator">==</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SortBy</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">long</span><span class="token punctuation">></span></span> <span class="token function">GetFollowerCountAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _followCollection<span class="token punctuation">.</span><span class="token function">CountDocumentsAsync</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>DstUuid <span class="token operator">==</span> uuid
                                                            <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Status <span class="token operator">==</span> FollowStatus<span class="token punctuation">.</span>Follow<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/argument-incorrect-type-expected-ndarray/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/argument-incorrect-type-expected-ndarray/" class="post-title-link" itemprop="url">TypeError: Argument has incorrect type (expected numpy.ndarray, got DataFrame) 解决方案</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-11-02 12:20:29 / 修改时间：12:27:22" itemprop="dateCreated datePublished" datetime="2024-11-02T12:20:29+08:00">2024-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/argument-incorrect-type-expected-ndarray/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/argument-incorrect-type-expected-ndarray/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/argument-incorrect-type-expected-ndarray/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在conda环境中升级软件包后，talib无法接受DataFrame作为输入，错误信息如下所示：<code>TypeError: Argument 'xxx' has incorrect type (expected numpy.ndarray, got DataFrame)</code>：</p>
<pre class="line-numbers language-none"><code class="language-none">Traceback (most recent call last):
  File &quot;&#x2F;data&#x2F;1.py&quot;, line 7, in &lt;module&gt;
    df[&#39;SMA_5&#39;] &#x3D; ta.SMA(df[&#39;Close&#39;], timeperiod&#x3D;5)
  File &quot;&#x2F;data&#x2F;miniconda3&#x2F;envs&#x2F;a&#x2F;lib&#x2F;python3.10&#x2F;site-packages&#x2F;talib&#x2F;__init__.py&quot;, line 64, in wrapper
    result &#x3D; func(*_args, **_kwds)
TypeError: Argument &#39;real&#39; has incorrect type (expected numpy.ndarray, got DataFrame)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大多数网络搜索结果都具有误导性，比如将df转换为np数组。由于在更新软件包之前代码能够正常运行，因此问题应为软件包不兼容的问题。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/argument-incorrect-type-expected-ndarray/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/en/argument-incorrect-type-expected-ndarray/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/en/argument-incorrect-type-expected-ndarray/" class="post-title-link" itemprop="url">TypeError: Argument has incorrect type (expected numpy.ndarray, got DataFrame) Solution</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-11-02 12:06:56 / 修改时间：12:27:22" itemprop="dateCreated datePublished" datetime="2024-11-02T12:06:56+08:00">2024-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/en/argument-incorrect-type-expected-ndarray/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/en/argument-incorrect-type-expected-ndarray/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/en/argument-incorrect-type-expected-ndarray/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>After upgrading packages in a conda env, talib cannot accept
dataframe as input, the error message looks like
<code>TypeError: Argument 'xxx' has incorrect type (expected numpy.ndarray, got DataFrame)</code>:</p>
<pre class="line-numbers language-none"><code class="language-none">Traceback (most recent call last):
  File &quot;&#x2F;data&#x2F;1.py&quot;, line 7, in &lt;module&gt;
    df[&#39;SMA_5&#39;] &#x3D; ta.SMA(df[&#39;Close&#39;], timeperiod&#x3D;5)
  File &quot;&#x2F;data&#x2F;miniconda3&#x2F;envs&#x2F;a&#x2F;lib&#x2F;python3.10&#x2F;site-packages&#x2F;talib&#x2F;__init__.py&quot;, line 64, in wrapper
    result &#x3D; func(*_args, **_kwds)
TypeError: Argument &#39;real&#39; has incorrect type (expected numpy.ndarray, got DataFrame)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Most of the web search results are misleading, like changing the df
into np array. Since the code works before updating packages, the
problem should be package incompatibility issue.</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/en/argument-incorrect-type-expected-ndarray/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/en/drive-d-usable-but-not-visible-in-file-explorer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/en/drive-d-usable-but-not-visible-in-file-explorer/" class="post-title-link" itemprop="url">Windows 11 drive D usable but not visible in File Explorer</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-10-13 00:40:35 / 修改时间：00:42:39" itemprop="dateCreated datePublished" datetime="2024-10-13T00:40:35+08:00">2024-10-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Misc/" itemprop="url" rel="index"><span itemprop="name">Misc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/en/drive-d-usable-but-not-visible-in-file-explorer/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/en/drive-d-usable-but-not-visible-in-file-explorer/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/en/drive-d-usable-but-not-visible-in-file-explorer/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Today, I encountered a strange issue in Windows 11 where the D drive
was visible in the Disk Management tool but not in File Explorer. I
searched online for many solutions, such as updating drivers in Device
Manager, disabling and re-enabling the device, using
<code>diskpart</code> to delete and recreate the partition, changing the
volume label, changing the drive letter, etc., but none worked.</p>
<h2 id="problem-description">Problem Description</h2>
<ul>
<li>A new D drive, visible in <code>diskmgmt.msc</code> Disk Management,
everything seemed normal. It could even be accessed in File Explorer
(though the drive wasn’t displayed in the left sidebar).</li>
<li>The D drive could be used normally, such as via the command
line.</li>
<li>Changing the drive letter to “E” or another letter made it visible
in File Explorer, but switching it back to “D” caused it to disappear
again.</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/en/drive-d-usable-but-not-visible-in-file-explorer/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/drive-d-usable-but-not-visible-in-file-explorer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/drive-d-usable-but-not-visible-in-file-explorer/" class="post-title-link" itemprop="url">Win11 D盘可用但在文件浏览器中不可见</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-10-13 00:13:33 / 修改时间：00:42:39" itemprop="dateCreated datePublished" datetime="2024-10-13T00:13:33+08:00">2024-10-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Misc/" itemprop="url" rel="index"><span itemprop="name">Misc</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/drive-d-usable-but-not-visible-in-file-explorer/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/drive-d-usable-but-not-visible-in-file-explorer/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/drive-d-usable-but-not-visible-in-file-explorer/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>今天遇到Win11中 D
盘在磁盘管理工具中显示可用，但在文件管理器中却不可见的诡异情况。网上搜了许多方案，如在设备管理器中更新驱动，禁用再启用设备，用<code>diskpart</code>重新删除新建分区，改卷标改盘符等等都不好使。</p>
<h2 id="问题描述">问题描述</h2>
<ul>
<li>新建D盘，在<code>diskmgmt.msc</code>磁盘管理器中可见，一切正常。甚至能打开文件浏览器（只是左栏不显示磁盘）</li>
<li>D盘可正常使用，如在命令行中使用</li>
<li>修改盘符为“E”或其他盘符，文件浏览器中就可见了，但改回“D”又会消失</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/drive-d-usable-but-not-visible-in-file-explorer/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/en/use-az-cli-to-query-multiple-fields/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/en/use-az-cli-to-query-multiple-fields/" class="post-title-link" itemprop="url">Use az cli to Query Multiple Fields of Resource Information</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-11 21:53:33 / 修改时间：21:53:53" itemprop="dateCreated datePublished" datetime="2024-09-11T21:53:33+08:00">2024-09-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/en/use-az-cli-to-query-multiple-fields/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/en/use-az-cli-to-query-multiple-fields/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/en/use-az-cli-to-query-multiple-fields/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Use <code>az cli</code> to query multiple fields of VM information.
Here we need to use JMESPath language to implement it.</p>
<p>Typically, we will use <code>az vm show</code> to get the detailed VM
information:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ az vm show <span class="token parameter variable">-g</span> Linux <span class="token parameter variable">-n</span> alpha <span class="token parameter variable">-d</span> <span class="token parameter variable">-o</span> table
Name    ResourceGroup    PowerState    PublicIps     Fqdns    Location    Zones
------  ---------------  ------------  ------------  -------  ----------  -------
alpha   Linux            VM running    <span class="token number">11.1</span>.111.111           eastasia    <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/en/use-az-cli-to-query-multiple-fields/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/llm-can-accurately-predict-searcher-preferences/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/llm-can-accurately-predict-searcher-preferences/" class="post-title-link" itemprop="url">基于LLM评估搜索系统</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-08-29 08:30:26 / 修改时间：16:39:21" itemprop="dateCreated datePublished" datetime="2024-08-29T08:30:26+08:00">2024-08-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/llm-can-accurately-predict-searcher-preferences/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/llm-can-accurately-predict-searcher-preferences/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/llm-can-accurately-predict-searcher-preferences/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>搜索系统的评估和调优很大程度上依赖于相关性标签——这些标签标注了某个文档对特定搜索和搜索者是否有用。理想情况下，这些标签来自真实的搜索用户，但要大规模收集这些数据非常困难，所以典型的实验依赖于第三方标注人员，但他们也可能产生不准确的标注。标注质量一般通过持续的审核、培训和监控来管理。</p>
<p>微软（Bing搜索组）在SIGIR'24提出了一种“反其道而行之”的方法：从真实的用户获取反馈，并利用这些反馈来选择一个与之相符的LLM及其提示词，然后令该LLM大规模地产生标签。实验表明，LLM的准确性与人工标注者相当，并且在找到最佳系统和最难的查询方面同样有用。</p>
<p>[SIGIR2024] <a
target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/research/publication/large-language-models-can-accurately-predict-searcher-preferences/">#
Large Language Models can Accurately Predict Searcher
Preferences</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/llm-can-accurately-predict-searcher-preferences/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/is-chatgpt-good-at-search-ranking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/is-chatgpt-good-at-search-ranking/" class="post-title-link" itemprop="url">ChatGPT擅长搜索排序吗？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-07-21 22:15:25" itemprop="dateCreated datePublished" datetime="2024-07-21T22:15:25+08:00">2024-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 00:11:06" itemprop="dateModified" datetime="2024-07-22T00:11:06+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/is-chatgpt-good-at-search-ranking/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/is-chatgpt-good-at-search-ranking/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/is-chatgpt-good-at-search-ranking/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>大语言模型在各种与语言相关的任务中表现出了显著的零样本泛化能力，包括搜索引擎。然而，现有的工作主要利用LLM的生成能力进行信息检索，而不是直接进行段落排序。这篇EMNLP2023的论文(Outstanding
Paper)研究了LLM是否擅长搜索排序的问题。</p>
<p><a target="_blank" rel="noopener" href="https://aclanthology.org/2023.emnlp-main.923/"># Is ChatGPT
Good at Search? Investigating Large Language Models as Re-Ranking
Agents</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/is-chatgpt-good-at-search-ranking/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/xtr-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/xtr-summary/" class="post-title-link" itemprop="url">Rethinking the Role of Token Retrieval in Multi-Vector Retrieval简读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-06-30 18:58:25" itemprop="dateCreated datePublished" datetime="2024-06-30T18:58:25+08:00">2024-06-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-23 09:57:31" itemprop="dateModified" datetime="2024-07-23T09:57:31+08:00">2024-07-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论：</span>
  
    <a title="waline" href="/xtr-summary/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/xtr-summary/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/xtr-summary/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>之前写过深度检索模型的介绍：<a href="/retrievermodels/">#
深度文本检索模型：DPR, PolyEncoders, DCBERT,
ColBERT</a>，今天来看看DeepMind在NeurIPS
2024上的文章，对多向量检索模型（Multi-Vector
Retrieval）ColBERT进行了改进：</p>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2304.01982">Rethinking the Role of
Token Retrieval in Multi-Vector Retrieval</a></p>
<p>多向量检索模型由于使Query与Doc进行词元级别的交互，因此在许多信息检索基准测试中达到了SOTA。然而，其非线性评分函数无法扩展到数百万个文档，这就需要一个三阶段的推理过程：通过词元检索检索初始候选，访问所有词元向量，并对初始候选文档进行评分。非线性评分函数应用于每个候选文档的所有词元向量，使得推理过程复杂且缓慢。XTR
引入了新的目标函数，鼓励模型首先检索最重要的文档词元，对词元检索的改进使得
XTR
可以仅使用检索到的词元来对候选文档排序，而不是文档中的所有词元，因此其成本比
ColBERT 低两到三个数量级。在流行的 BEIR 基准测试中，XTR
在没有任何蒸馏的情况下，将 NDCG@10 提升了 2.8。</p>
<p>主要改进点：</p>
<ul>
<li>仅使用检索到的doc token而非全部doc token进行相似度计算</li>
<li>解决了检索训练和推理之间的gap</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/xtr-summary/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">finisky</span>
</div><div><span class="post-meta-item-icon"><i class="far fa-eye"></i></span><span><a href="https://finicounter.eu.org/" target="_blank">Total Views</a>:</span><span id="finicount_views" style="display:inline;padding-left:5px;"></span><div> <script async src="//finicounter.eu.org/finicounter.js"></script>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/finisky" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  




  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"en","enable":true,"serverURL":"https://comments.finisky.eu.org","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":true,"pageSize":10,"el":"#waline","comment":true,"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","path":"/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>


        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body>
</html>
