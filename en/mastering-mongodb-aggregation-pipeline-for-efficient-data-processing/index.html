<!DOCTYPE html>
<html lang="en">
<head><!-- hexo injector head_begin start --><!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-K4DEGPDYSW"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag("js", new Date()); gtag("config", "G-K4DEGPDYSW"); </script><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">
  <meta name="google-site-verification" content="oFhcvcGsjsTY5AFUaI-ezbn7-bel9NrdUNpeQfwZSwI">
  <meta name="msvalidate.01" content="F8E2F274161B653649F8818FD127CE87">
  <meta name="yandex-verification" content="ff1f79abcbf80d7e">
  <meta name="baidu-site-verification" content="code-nNL5JO7sPl">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"finisky.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="MongoDB&#39;s Aggregation Pipeline is a powerful tool for processing and analyzing data, suitable for both real-time queries and offline data analysis. It allows developers to use multiple stages to trans">
<meta property="og:type" content="article">
<meta property="og:title" content="Mastering MongoDB Aggregation Pipeline for Efficient Data Processing">
<meta property="og:url" content="https://finisky.github.io/en/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/index.html">
<meta property="og:site_name" content="Finisky Garden">
<meta property="og:description" content="MongoDB&#39;s Aggregation Pipeline is a powerful tool for processing and analyzing data, suitable for both real-time queries and offline data analysis. It allows developers to use multiple stages to trans">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-03-26T14:48:39.000Z">
<meta property="article:modified_time" content="2025-03-26T14:51:12.000Z">
<meta property="article:author" content="finisky">
<meta property="article:tag" content="MongoDB">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://finisky.github.io/en/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://finisky.github.io/en/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/","path":"/en/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/","title":"Mastering MongoDB Aggregation Pipeline for Efficient Data Processing"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Mastering MongoDB Aggregation Pipeline for Efficient Data Processing | Finisky Garden</title>
  







<link rel="dns-prefetch" href="https://comments.finisky.eu.org">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script type="text/javascript"> function downloadJsAtOnload() { setTimeout(function downloadJs() { var element = document.createElement("script"); element.setAttribute("data-ad-client", "ca-pub-2660281922577700"); element.async = true; element.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"; document.body.appendChild(element); }, 5000); }; if (window.addEventListener) window.addEventListener("load", downloadJsAtOnload, false); else if (window.attachEvent) window.attachEvent("onload", downloadJsAtOnload); else window.onload = downloadJsAtOnload; </script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Finisky Garden" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Finisky Garden</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">NLP, 软件工程, 产品设计</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-nlp"><a href="/tags/NLP/" rel="section"><i class="fa fa-language fa-fw"></i>NLP</a></li><li class="menu-item menu-item-mongodb"><a href="/categories/MongoDB/" rel="section"><i class="fas fa-database fa-fw"></i>MongoDB</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-友链"><a href="/links/" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#aggregation-pipeline-basics"><span class="nav-number">1.</span> <span class="nav-text">Aggregation Pipeline Basics</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#aggregation-use-cases"><span class="nav-number">2.</span> <span class="nav-text">Aggregation Use Cases</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#real-time-data-analysis-and-monitoring"><span class="nav-number">2.1.</span> <span class="nav-text">Real-time Data Analysis
and Monitoring</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#data-etl-and-pre-aggregation"><span class="nav-number">2.2.</span> <span class="nav-text">Data ETL and Pre-aggregation</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#practical-aggregation-sample"><span class="nav-number">3.</span> <span class="nav-text">Practical Aggregation Sample</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#data-preparation"><span class="nav-number">3.1.</span> <span class="nav-text">Data Preparation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#match-filter-data"><span class="nav-number">3.2.</span> <span class="nav-text">$match Filter Data</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#group"><span class="nav-number">3.3.</span> <span class="nav-text">$group</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sort"><span class="nav-number">3.4.</span> <span class="nav-text">$sort</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#project"><span class="nav-number">3.5.</span> <span class="nav-text">$project</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unwind"><span class="nav-number">3.6.</span> <span class="nav-text">$unwind</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lookup"><span class="nav-number">3.7.</span> <span class="nav-text">$lookup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#combine-together"><span class="nav-number">3.8.</span> <span class="nav-text">Combine Together</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#performance-analysis-and-optimization"><span class="nav-number">4.</span> <span class="nav-text">Performance Analysis and
Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#performance-analysis"><span class="nav-number">4.1.</span> <span class="nav-text">Performance Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#performance-optimization"><span class="nav-number">4.2.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#index-optimization"><span class="nav-number">4.2.1.</span> <span class="nav-text">Index Optimization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reducing-lookup-dependency"><span class="nav-number">4.2.2.</span> <span class="nav-text">Reducing $lookup
Dependency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pipeline-stage-order-optimization"><span class="nav-number">4.2.3.</span> <span class="nav-text">Pipeline Stage Order
Optimization</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="finisky"
      src="/images/qrcode.jpg">
  <p class="site-author-name" itemprop="name">扫码关注公众号</p>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">267</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/" rel="bookmark">
        <time class="popular-posts-time">2025-03-26</time>
        <br>
      MongoDB Aggregation Pipeline入门
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/mongodbendlessretry.en/" rel="bookmark">
        <time class="popular-posts-time">2021-12-16</time>
        <br>
      MongoDB Transaction BulkWrite Endless Retry
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2021/02/27/mongodbstronlytypedcollectionexample.en/" rel="bookmark">
        <time class="popular-posts-time">2021-02-27</time>
        <br>
      MongoDB Strongly-Typed Collection Usage Example
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/sqlservercleanupqueries.en/" rel="bookmark">
        <time class="popular-posts-time">2021-05-02</time>
        <br>
      SQL Server CleanUp Database Queries
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/en/use-az-cli-to-query-multiple-fields/" rel="bookmark">
        <time class="popular-posts-time">2024-09-11</time>
        <br>
      Use az cli to Query Multiple Fields of Resource Information
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/en/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Mastering MongoDB Aggregation Pipeline for Efficient Data Processing | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Mastering MongoDB Aggregation Pipeline for Efficient Data Processing
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-26 22:48:39 / Modified: 22:51:12" itemprop="dateCreated datePublished" datetime="2025-03-26T22:48:39+08:00">2025-03-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论: </span>
  
    <a title="waline" href="/en/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/en/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="waline-pageview-count" data-path="/en/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>MongoDB's Aggregation Pipeline is a powerful tool for processing and
analyzing data, suitable for both real-time queries and offline data
analysis. It allows developers to use multiple stages to transform,
filter, group, and sort data, enabling efficient execution of complex
computations. This article will explore the basic concepts, application
examples, performance analysis, and optimization strategies of the
Aggregation Pipeline.</p>
<span id="more"></span>
<h1 id="aggregation-pipeline-basics">Aggregation Pipeline Basics</h1>
<p>The Aggregation Pipeline consists of multiple stages, each
responsible for a specific data processing task, such as:</p>
<ul>
<li><p><code>$match</code>: Filters documents, similar to SQL's
<code>WHERE</code>, reducing the amount of data scanned. For example,
<code>SELECT * FROM orders WHERE status = 'active';</code> is equivalent
to <code>&#123; "$match": &#123; "status": "active" &#125; &#125;</code>.</p></li>
<li><p><code>$group</code>: Groups data and computes aggregate values,
similar to SQL's <code>GROUP BY</code>. For example,
<code>SELECT category, COUNT(*) FROM orders GROUP BY category;</code>
can be achieved in MongoDB with
<code>&#123; "$group": &#123; "_id": "$category", "count": &#123; "$sum": 1 &#125; &#125; &#125;</code>.</p></li>
<li><p><code>$sort</code>: Sorts data, similar to SQL's
<code>ORDER BY</code>, for example,
<code>SELECT * FROM orders ORDER BY createdAt DESC;</code> is equivalent
to <code>&#123; "$sort": &#123; "createdAt": -1 &#125; &#125;</code>.</p></li>
<li><p><code>$project</code>: Adjusts the output fields, similar to
SQL's <code>SELECT column1, column2 FROM table;</code>, which can be
implemented in MongoDB with
<code>&#123; "$project": &#123; "name": 1, "price": 1 &#125; &#125;</code>.</p></li>
<li><p><code>$lookup</code>: Performs a table join (similar to SQL's
<code>JOIN</code>), for example, SQL's
<code>SELECT * FROM orders INNER JOIN customers ON orders.customerId = customers.id;</code>
can be implemented in MongoDB with
<code>&#123; "$lookup": &#123; "from": "customers", "localField": "customerId", "foreignField": "_id", "as": "customer" &#125; &#125;</code>.</p></li>
<li><p><code>$unwind</code>: Expands array fields, similar to SQL's
<code>LATERAL VIEW</code>, useful for processing nested data.</p></li>
<li><p><code>$merge</code>: Writes the result to a new collection,
similar to SQL's
<code>INSERT INTO new_table SELECT * FROM old_table;</code>.</p></li>
</ul>
<p>Here is an example of an aggregation: filtering all documents where
status is active, grouping them by category, calculating the count of
documents in each category, and sorting the results by the count in
descending order:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span> <span class="token property">"$match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"active"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> <span class="token property">"$group"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"$category"</span><span class="token punctuation">,</span> <span class="token property">"count"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"$sum"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> <span class="token property">"$sort"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"count"</span><span class="token operator">:</span> <span class="token number">-1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="aggregation-use-cases">Aggregation Use Cases</h1>
<h2 id="real-time-data-analysis-and-monitoring">Real-time Data Analysis
and Monitoring</h2>
<p>In many business scenarios, companies need to monitor and analyze
real-time data for quick decision-making. For example, in an e-commerce
platform, analyzing user access data in real-time can help optimize
recommendation systems, while in the financial industry, transaction
monitoring can be used for fraud detection.</p>
<p>The Aggregation Pipeline allows developers to build efficient data
flow processing systems. For example, using <code>$match</code> to
filter specific transaction types and combining <code>$group</code> to
calculate statistics can enable real-time monitoring of abnormal
transactions. For instance:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span> <span class="token property">"$match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"transactionAmount"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"$gt"</span><span class="token operator">:</span> <span class="token number">10000</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> <span class="token property">"$group"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"$userId"</span><span class="token punctuation">,</span> <span class="token property">"totalSpent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"$sum"</span><span class="token operator">:</span> <span class="token string">"$transactionAmount"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> <span class="token property">"$sort"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"totalSpent"</span><span class="token operator">:</span> <span class="token number">-1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>This Aggregation Pipeline monitors high-value transactions in
real-time, sorting users' spending behavior, and helping identify
suspicious transactions.</p>
<h2 id="data-etl-and-pre-aggregation">Data ETL and Pre-aggregation</h2>
<p>For data warehouse and big data analysis scenarios, the Aggregation
Pipeline can be used for data extraction (ETL) and pre-aggregation,
reducing query overhead and improving performance. For example, a social
media platform may need to analyze historical user behavior data to
generate personalized recommendations.</p>
<p>A typical ETL task may include:</p>
<ul>
<li>Using <code>$lookup</code> to join data from multiple collections,
such as user behavior logs and product information.</li>
<li>Filtering invalid data to reduce storage pressure.</li>
<li>Using <code>$group</code> to aggregate calculations and generate
precomputed data tables.</li>
<li>Using <code>$merge</code> to store the data into a new collection
for future queries.</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span> <span class="token property">"$match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"eventType"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"$in"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"purchase"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> <span class="token property">"$group"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"$userId"</span><span class="token punctuation">,</span> <span class="token property">"interactions"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"$push"</span><span class="token operator">:</span> <span class="token string">"$eventType"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> <span class="token property">"$merge"</span><span class="token operator">:</span> <span class="token string">"user_behavior_summary"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>With such an Aggregation Pipeline, businesses can pre-compute user
behavior characteristics, reducing the computational pressure during
online queries and improving query performance. This approach is
especially suitable for large-scale data processing, such as
recommendation systems, ad targeting optimization, and user behavior
analysis.</p>
<h1 id="practical-aggregation-sample">Practical Aggregation Sample</h1>
<p>In this section, we will use a complete example to demonstrate how
Aggregation works.</p>
<h2 id="data-preparation">Data Preparation</h2>
<p>Before we begin the Aggregation demonstration, we need to prepare an
example database called <code>sales_db</code>, which contains a
collection called <code>orders</code> with the following structure:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"order_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"customer"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span>
    <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span> <span class="token property">"product"</span><span class="token operator">:</span> <span class="token string">"Laptop"</span><span class="token punctuation">,</span> <span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token property">"product"</span><span class="token operator">:</span> <span class="token string">"Mouse"</span><span class="token punctuation">,</span> <span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token property">"quantity"</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">1100</span><span class="token punctuation">,</span>
    <span class="token property">"date"</span><span class="token operator">:</span> ISODate(<span class="token string">"2024-03-10T10:00:00Z"</span>)
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Insert some sample data using the mongo shell (including the
<code>orders</code> and <code>customers</code> collections):</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">></span> use sales_db
<span class="token operator">></span> db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"order_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string-property property">"customer"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Laptop"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Mouse"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token number">1100</span><span class="token punctuation">,</span>
        <span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span><span class="token string">"2024-03-10T10:00:00Z"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"order_id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token string-property property">"customer"</span><span class="token operator">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Monitor"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Keyboard"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token number">380</span><span class="token punctuation">,</span>
        <span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span><span class="token string">"2024-03-12T14:30:00Z"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"order_id"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token string-property property">"customer"</span><span class="token operator">:</span> <span class="token string">"Charlie"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Tablet"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Headphones"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token number">700</span><span class="token punctuation">,</span>
        <span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span><span class="token string">"2024-03-15T09:45:00Z"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"order_id"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token string-property property">"customer"</span><span class="token operator">:</span> <span class="token string">"David"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Smartphone"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">900</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Charger"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token number">930</span><span class="token punctuation">,</span>
        <span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span><span class="token string">"2024-03-18T12:10:00Z"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"order_id"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string-property property">"customer"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Laptop"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">1200</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span> <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"Mouse Pad"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token number">1220</span><span class="token punctuation">,</span>
        <span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span><span class="token string">"2024-03-20T15:30:00Z"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">></span> db<span class="token punctuation">.</span>customers<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span> <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token string-property property">"email"</span><span class="token operator">:</span> <span class="token string">"alice@example.com"</span><span class="token punctuation">,</span> <span class="token string-property property">"phone"</span><span class="token operator">:</span> <span class="token string">"123-456-7890"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token string-property property">"email"</span><span class="token operator">:</span> <span class="token string">"bob@example.com"</span><span class="token punctuation">,</span> <span class="token string-property property">"phone"</span><span class="token operator">:</span> <span class="token string">"234-567-8901"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"Charlie"</span><span class="token punctuation">,</span> <span class="token string-property property">"email"</span><span class="token operator">:</span> <span class="token string">"charlie@example.com"</span><span class="token punctuation">,</span> <span class="token string-property property">"phone"</span><span class="token operator">:</span> <span class="token string">"345-678-9012"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"David"</span><span class="token punctuation">,</span> <span class="token string-property property">"email"</span><span class="token operator">:</span> <span class="token string">"david@example.com"</span><span class="token punctuation">,</span> <span class="token string-property property">"phone"</span><span class="token operator">:</span> <span class="token string">"456-789-0123"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>After inserting the data, view it using MongoDB Compass:</p>
<p><img
src="https://coriva.eu.org/images/mongodb/salesdbdata.png" /></p>
<h2 id="match-filter-data"><code>$match</code> Filter Data</h2>
<p>Retrieve orders where <code>total</code> is greater than 500:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span> <span class="token literal-property property">$match</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">$gt</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>The execution result in the Aggregations Tab of Compass (note that
only the content within the parentheses should be used):</p>
<p><img
src="https://coriva.eu.org/images/mongodb/salesdbmatch.png" /></p>
<h2 id="group"><code>$group</code></h2>
<p>Group by customer and calculate the total amount spent by each
customer:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span> <span class="token literal-property property">$group</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">"$customer"</span><span class="token punctuation">,</span> <span class="token literal-property property">total_spent</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">$sum</span><span class="token operator">:</span> <span class="token string">"$total"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Results:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>
  <span class="token property">"total_spent"</span><span class="token operator">:</span> <span class="token number">380</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"Charlie"</span><span class="token punctuation">,</span>
  <span class="token property">"total_spent"</span><span class="token operator">:</span> <span class="token number">700</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span>
  <span class="token property">"total_spent"</span><span class="token operator">:</span> <span class="token number">2320</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"David"</span><span class="token punctuation">,</span>
  <span class="token property">"total_spent"</span><span class="token operator">:</span> <span class="token number">930</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="sort"><code>$sort</code></h2>
<p>Sort by total amount spent per customer in descending order:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span> <span class="token literal-property property">$group</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token string">"$customer"</span><span class="token punctuation">,</span> <span class="token literal-property property">total_spent</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">$sum</span><span class="token operator">:</span> <span class="token string">"$total"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> <span class="token literal-property property">$sort</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">total_spent</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Results:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span>
  <span class="token property">"total_spent"</span><span class="token operator">:</span> <span class="token number">2320</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"David"</span><span class="token punctuation">,</span>
  <span class="token property">"total_spent"</span><span class="token operator">:</span> <span class="token number">930</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"Charlie"</span><span class="token punctuation">,</span>
  <span class="token property">"total_spent"</span><span class="token operator">:</span> <span class="token number">700</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>
  <span class="token property">"total_spent"</span><span class="token operator">:</span> <span class="token number">380</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="project"><code>$project</code></h2>
<p>Only display the order_id, customer, and total amount:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span> <span class="token literal-property property">$project</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">order_id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">customer</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Results:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"order_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"customer"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span>
  <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">1100</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"order_id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">"customer"</span><span class="token operator">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>
  <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">380</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"order_id"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">"customer"</span><span class="token operator">:</span> <span class="token string">"Charlie"</span><span class="token punctuation">,</span>
  <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">700</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"order_id"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token property">"customer"</span><span class="token operator">:</span> <span class="token string">"David"</span><span class="token punctuation">,</span>
  <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">930</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"order_id"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token property">"customer"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span>
  <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">1220</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="unwind"><code>$unwind</code></h2>
<p>Unwind the <code>items</code> array so that each product in an order
becomes a separate document:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span> <span class="token literal-property property">$unwind</span><span class="token operator">:</span> <span class="token string">"$items"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Partial results:</p>
<p><img
src="https://coriva.eu.org/images/mongodb/salesdbunwind.png" /></p>
<h2 id="lookup"><code>$lookup</code></h2>
<p>The <code>customers</code> collection contains detailed information
about customers. We can use <code>$lookup</code> to perform a join-like
operation to associate the data:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">$lookup</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">"customers"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">localField</span><span class="token operator">:</span> <span class="token string">"customer"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">foreignField</span><span class="token operator">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span>
            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">"customer_info"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Partial result, the customer's detailed information is now in the
<code>customer_info</code>:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"$oid"</span><span class="token operator">:</span> <span class="token string">"67e27bc5a0e546aa21164c95"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"order_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"customer"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span>
  <span class="token property">"items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"product"</span><span class="token operator">:</span> <span class="token string">"Laptop"</span><span class="token punctuation">,</span>
      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      <span class="token property">"quantity"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"product"</span><span class="token operator">:</span> <span class="token string">"Mouse"</span><span class="token punctuation">,</span>
      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
      <span class="token property">"quantity"</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">1100</span><span class="token punctuation">,</span>
  <span class="token property">"date"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"$date"</span><span class="token operator">:</span> <span class="token string">"2024-03-10T10:00:00.000Z"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"customer_info"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span>
      <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"alice@example.com"</span><span class="token punctuation">,</span>
      <span class="token property">"phone"</span><span class="token operator">:</span> <span class="token string">"123-456-7890"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="combine-together">Combine Together</h2>
<p>We can combine multiple stages together to meet complex data analysis
requirements. For example, to calculate the total number of orders and
total spending for each customer in March 2024, while also retrieving
the customer's email and sorting by total spending in descending
order:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"$match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string-property property">"$gte"</span><span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2024-03-01T00:00:00Z"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"$lt"</span><span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2024-04-01T00:00:00Z"</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"$lookup"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"from"</span><span class="token operator">:</span> <span class="token string">"customers"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"localField"</span><span class="token operator">:</span> <span class="token string">"customer"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"foreignField"</span><span class="token operator">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"as"</span><span class="token operator">:</span> <span class="token string">"customer_info"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"$project"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"customer"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">"email"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"$arrayElemAt"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"$customer_info.email"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"$group"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token string">"$customer"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"totalOrders"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"$sum"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token string-property property">"totalSpent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"$sum"</span><span class="token operator">:</span> <span class="token string">"$total"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token string-property property">"email"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"$first"</span><span class="token operator">:</span> <span class="token string">"$email"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"$sort"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"totalSpent"</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Results:</p>
<p><img
src="https://coriva.eu.org/images/mongodb/salesdbcomplex.png" /></p>
<h1 id="performance-analysis-and-optimization">Performance Analysis and
Optimization</h1>
<h2 id="performance-analysis">Performance Analysis</h2>
<p>Methods to analyze the performance of the Aggregation Pipeline
include:</p>
<ul>
<li><code>explain()</code> diagnostic: Use
<code>db.collection.aggregate([...]).explain("executionStats")</code> to
analyze the query plan, check index usage, and examine the execution of
each stage.</li>
<li>Profiler: Enable the MongoDB Profiler
(<code>db.setProfilingLevel(2)</code>) to log slow queries and analyze
the <code>system.profile</code> collection. Check execution time.</li>
<li>MongoDB Atlas Performance Advisor (if using Atlas): Provides
automatic optimization recommendations.</li>
</ul>
<h2 id="performance-optimization">Performance Optimization</h2>
<p>In general, the performance of Aggregation is influenced by the
following factors: - Index usage: The <code>$match</code> stage should
make use of indexes as much as possible to reduce the amount of data
scanned. - Stage order: Place <code>$match</code> first to reduce the
amount of data processed in subsequent stages. - Data volume: When
handling large datasets, the pipeline may consume a significant amount
of memory.</p>
<h3 id="index-optimization">Index Optimization</h3>
<p>Ensure that <code>$match</code> uses indexes to improve query
efficiency. For example:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">db.orders.createIndex<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"createdAt"</span><span class="token builtin class-name">:</span> <span class="token parameter variable">-1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="reducing-lookup-dependency">Reducing <code>$lookup</code>
Dependency</h3>
<p><code>$lookup</code> can cause performance degradation. Some
optimization strategies include:</p>
<ul>
<li>Preprocess data to avoid runtime <code>JOIN</code>.</li>
<li>Use nested documents to store related data.</li>
</ul>
<h3 id="pipeline-stage-order-optimization">Pipeline Stage Order
Optimization</h3>
<p>Optimize the stages order:</p>
<ol type="1">
<li><strong><code>$match</code></strong> - Filter data first to reduce
the processing load for subsequent stages.</li>
<li><strong><code>$project</code></strong> - Remove unnecessary fields
to reduce overhead.</li>
<li><strong><code>$sort</code></strong> - Use indexing for sorting when
appropriate to avoid memory consumption.</li>
<li><strong><code>$group</code></strong> - Only aggregate when
necessary.</li>
</ol>
<p>MongoDB Aggregation Pipeline provides powerful data processing
capabilities, suitable for data analysis, ETL, and offline tasks. By
using indexes wisely, optimizing the Pipeline structure, and adopting
sharding techniques, performance can be significantly improved.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MongoDB/" rel="tag"># MongoDB</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/" rel="prev" title="MongoDB Aggregation Pipeline入门">
                  <i class="fa fa-chevron-left"></i> MongoDB Aggregation Pipeline入门
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/en/tex-mktexmf-cannot-find-font/" rel="next" title="TeX Live mktexmf cannot find font solution">
                  TeX Live mktexmf cannot find font solution <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">finisky</span>
</div><div><span class="post-meta-item-icon"><i class="far fa-eye"></i></span><span><a href="https://finicounter.eu.org/" target="_blank">Total Views</a>:</span><span id="finicount_views" style="display:inline;padding-left:5px;"></span><div> <script async src="//finicounter.eu.org/finicounter.js"></script>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/finisky" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  




  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"en","enable":true,"serverURL":"https://comments.finisky.eu.org","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":true,"pageSize":10,"el":"#waline","comment":true,"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","path":"/en/mastering-mongodb-aggregation-pipeline-for-efficient-data-processing/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>


        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body>
</html>
