<!DOCTYPE html>
<html lang="en">
<head><!-- hexo injector head_begin start --><!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-K4DEGPDYSW"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag("js", new Date()); gtag("config", "G-K4DEGPDYSW"); </script><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">
  <meta name="google-site-verification" content="oFhcvcGsjsTY5AFUaI-ezbn7-bel9NrdUNpeQfwZSwI">
  <meta name="msvalidate.01" content="F8E2F274161B653649F8818FD127CE87">
  <meta name="yandex-verification" content="ff1f79abcbf80d7e">
  <meta name="baidu-site-verification" content="code-nNL5JO7sPl">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"finisky.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Transaction systems are at the heart of modern commerce and financial activities, spanning a wide range of scenarios from e-commerce order processing to real-time settlements in financial institutions">
<meta property="og:type" content="article">
<meta property="og:title" content="Building a Transaction System with MongoDB">
<meta property="og:url" content="https://finisky.github.io/en/building-a-transaction-system-with-mongodb/index.html">
<meta property="og:site_name" content="Finisky Garden">
<meta property="og:description" content="Transaction systems are at the heart of modern commerce and financial activities, spanning a wide range of scenarios from e-commerce order processing to real-time settlements in financial institutions">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==">
<meta property="article:published_time" content="2024-11-24T04:58:00.000Z">
<meta property="article:modified_time" content="2024-11-28T11:40:44.000Z">
<meta property="article:author" content="finisky">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="MongoDB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==">


<link rel="canonical" href="https://finisky.github.io/en/building-a-transaction-system-with-mongodb/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://finisky.github.io/en/building-a-transaction-system-with-mongodb/","path":"/en/building-a-transaction-system-with-mongodb/","title":"Building a Transaction System with MongoDB"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Building a Transaction System with MongoDB | Finisky Garden</title>
  







<link rel="dns-prefetch" href="https://comments.finisky.eu.org">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start --><script type="text/javascript"> function downloadJsAtOnload() { setTimeout(function downloadJs() { var element = document.createElement("script"); element.setAttribute("data-ad-client", "ca-pub-2660281922577700"); element.async = true; element.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"; document.body.appendChild(element); }, 5000); }; if (window.addEventListener) window.addEventListener("load", downloadJsAtOnload, false); else if (window.attachEvent) window.attachEvent("onload", downloadJsAtOnload); else window.onload = downloadJsAtOnload; </script><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Finisky Garden" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Finisky Garden</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">NLP, 软件工程, 产品设计</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-nlp"><a href="/tags/NLP/" rel="section"><i class="fa fa-language fa-fw"></i>NLP</a></li><li class="menu-item menu-item-mongodb"><a href="/categories/MongoDB/" rel="section"><i class="fas fa-database fa-fw"></i>MongoDB</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-友链"><a href="/links/" rel="section"><i class="fas fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#problem-statement-and-challenges"><span class="nav-number">1.</span> <span class="nav-text">Problem Statement and
Challenges</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#data-modeling"><span class="nav-number">2.</span> <span class="nav-text">Data Modeling</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#system-implementation"><span class="nav-number">3.</span> <span class="nav-text">System Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#createaccount-api"><span class="nav-number">3.1.</span> <span class="nav-text">CreateAccount API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getbalance-api"><span class="nav-number">3.2.</span> <span class="nav-text">GetBalance API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#addbalance-decreasebalance-api"><span class="nav-number">3.3.</span> <span class="nav-text">AddBalance &amp; DecreaseBalance
API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gettransactionbytid-gettransactions-api"><span class="nav-number">3.4.</span> <span class="nav-text">GetTransactionByTid
&amp; GetTransactions API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#recharge-api"><span class="nav-number">3.5.</span> <span class="nav-text">Recharge API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#purchase-api"><span class="nav-number">3.6.</span> <span class="nav-text">Purchase API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#indexes-and-shard-keys"><span class="nav-number">3.7.</span> <span class="nav-text">Indexes and Shard Keys</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#test-code"><span class="nav-number">4.</span> <span class="nav-text">Test Code</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#full-demo"><span class="nav-number">5.</span> <span class="nav-text">Full Demo</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="finisky"
      src="/images/qrcode.jpg">
  <p class="site-author-name" itemprop="name">扫码关注公众号</p>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">257</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/mongodbendlessretry.en/" rel="bookmark">
        <time class="popular-posts-time">2021-12-16</time>
        <br>
      MongoDB Transaction BulkWrite Endless Retry
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2021/01/13/dontuseloadbalancerinfrontofmongos.en/" rel="bookmark">
        <time class="popular-posts-time">2021-01-13</time>
        <br>
      Don't Use Load Balancer In front of Mongos
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2021/02/20/mongodbretrytransaction.en/" rel="bookmark">
        <time class="popular-posts-time">2021-02-20</time>
        <br>
      How to Retry MongoDB Transaction
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/building-a-transaction-system-with-mongodb/" rel="bookmark">
        <time class="popular-posts-time">2024-11-24</time>
        <br>
      用MongoDB构建交易系统
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2021/01/13/dontuseloadbalancerinfrontofmongos/" rel="bookmark">
        <time class="popular-posts-time">2021-01-13</time>
        <br>
      别在mongos前做负载均衡
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://finisky.github.io/en/building-a-transaction-system-with-mongodb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/qrcode.jpg">
      <meta itemprop="name" content="finisky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Finisky Garden">
      <meta itemprop="description" content="互联网那些事儿：NLP, 软件工程, 产品设计">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Building a Transaction System with MongoDB | Finisky Garden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Building a Transaction System with MongoDB
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-11-24 12:58:00" itemprop="dateCreated datePublished" datetime="2024-11-24T12:58:00+08:00">2024-11-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-11-28 19:40:44" itemprop="dateModified" datetime="2024-11-28T19:40:44+08:00">2024-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论: </span>
  
    <a title="waline" href="/en/building-a-transaction-system-with-mongodb/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/en/building-a-transaction-system-with-mongodb/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="waline-pageview-count" data-path="/en/building-a-transaction-system-with-mongodb/"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>Transaction systems are at the heart of modern commerce and financial
activities, spanning a wide range of scenarios from e-commerce order
processing to real-time settlements in financial institutions. Such
systems demand high concurrency handling, real-time data storage, and
efficient retrieval capabilities, all while balancing data consistency
and performance. As transaction data continues to grow in scale and
complexity, traditional transaction system architectures often struggle
to meet these challenges due to rigid table structures and limited
horizontal scalability.</p>
<p>MongoDB, as a distributed document-oriented database, provides a
modern solution for building complex and efficient transaction systems.
With its flexible schema design, high throughput capabilities, and
built-in transaction support, MongoDB addresses diverse business needs
effectively.</p>
<span id="more"></span>
<h1 id="problem-statement-and-challenges">Problem Statement and
Challenges</h1>
<p>The core functionalities of a transaction system include account
management, balance inquiry, recharge, purchase, and managing and
querying transaction records. For instance, the following illustrates
how a user's account balance is displayed:</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://coriva.eu.org/images/mongodb/getbalance.jpg" /></p>
<p>Displays the user's transaction history: <img
src="https://coriva.eu.org/images/mongodb/gettransaction.jpg" /></p>
<p>Building an efficient and reliable modern transaction system involves
tackling several key challenges:</p>
<ol type="1">
<li><p><strong>High Concurrency</strong> Transaction systems must handle
large-scale concurrent requests, particularly in domains like finance
and e-commerce, where users frequently perform transactions, balance
inquiries, and other operations simultaneously. Failure to support high
concurrency can result in delayed responses or even system
crashes.</p></li>
<li><p><strong>Data Consistency and Transaction Management</strong>
Ensuring data consistency is critical, especially for sensitive
operations like account balance updates, transaction records, and
purchase. Any inconsistency could lead to financial risks and a loss of
user trust. Transaction management in distributed environments adds
another layer of complexity.</p></li>
<li><p><strong>Flexible Data Modeling</strong> Traditional relational
databases often rely on rigid table structures that struggle to adapt to
the complex and evolving business logic of transaction systems. Adding
new features often requires significant changes to the data model,
leading to high modification costs and potential service
disruptions.</p></li>
<li><p><strong>Real-Time Data Processing and Query Performance</strong>
With massive transaction volumes, the system must efficiently store,
retrieve, and process real-time user queries, such as balance checks and
transaction history retrievals. This demands a database with high
throughput and lightning-fast query performance.</p></li>
<li><p><strong>System Scalability</strong> As the business grows, the
volume of transaction data will continue to expand. The system must
support seamless horizontal scaling, ensuring that performance improves
linearly as additional servers or storage nodes are added.</p></li>
</ol>
<h1 id="data-modeling">Data Modeling</h1>
<p>To achieve large-scale data storage and high-concurrency read/write
capabilities, data modeling is the key challenge. MongoDB's document
model is renowned for its flexibility and efficiency, allowing it to
easily accommodate the complex and evolving needs of transaction
systems.</p>
<p>The following six APIs define the essential functionalities of the
transaction system:</p>
<ol type="1">
<li><p><strong><code>api/CreateAccount</code></strong> Creates a user
account, initializing basic user information and the initial
balance.</p></li>
<li><p><strong><code>api/GetBalance</code></strong> Retrieves the
account balance, ensuring real-time accuracy and consistency.</p></li>
<li><p><strong><code>api/GetTransactionById</code></strong> Fetches
transaction details based on a transaction ID, supporting quick and
precise lookups.</p></li>
<li><p><strong><code>api/GetTransactions</code></strong> Retrieves
historical transaction records for a specific account, with support for
pagination and time-range filtering to handle large-scale data
queries.</p></li>
<li><p><strong><code>api/Recharge</code></strong> Processes account
recharges, involving transaction handling to ensure synchronized updates
to the account balance and transaction records.</p></li>
<li><p><strong><code>api/Purchase</code></strong> Handles purchase
operations, ensuring transaction integrity and detailed operation
records.</p></li>
</ol>
<p>To address the above requirements, two collections are designed to
store user account states and detailed transaction information. The two
collections are linked through <code>Uuid</code>, enabling efficient
queries and updates.</p>
<ol type="1">
<li><strong><code>AccountEntry</code></strong> represents the basic
account information for each user in the system, with the following key
fields:</li>
</ol>
<ul>
<li><p><strong><code>Uuid</code> (string)</strong> A unique identifier
for each account, used to uniquely locate an account within the system.
Globally unique.</p></li>
<li><p><strong><code>Balance</code> (decimal)</strong> The current
balance of the account, stored as a precise decimal value to record the
total amount of funds available to the user.</p></li>
</ul>
<p>The <code>AccountEntry</code> definition:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountEntry</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Uuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">decimal</span></span> Balance <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> UpdateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2" type="1">
<li><strong><code>TransEntry</code></strong> records each transaction in
the system and supports various types of operations. The field
descriptions are as follows:</li>
</ol>
<ul>
<li><p><strong><code>Tid</code> (string)</strong> A unique identifier
for each transaction, used to uniquely locate a specific
transaction.</p></li>
<li><p><strong><code>Uuid</code> (string)</strong> The unique identifier
of the corresponding account, serving as a foreign key linked to
<code>AccountEntry</code>, indicating which account this transaction
belongs to.</p></li>
<li><p><strong><code>Amount</code> (decimal)</strong> The transaction
amount, recording the funds involved in this transaction.</p></li>
<li><p><strong><code>NewBalance</code> (decimal)</strong> A snapshot of
the account balance after the transaction is completed, enabling the
tracking of fund movements and supporting auditing
functionality.</p></li>
<li><p><strong><code>Type</code> (TransType)</strong> An enumeration of
transaction types, indicating the nature of the transaction.</p></li>
</ul>
<p>The <code>TransEntry</code> definition:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransEntry</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Tid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Uuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">decimal</span></span> Amount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">decimal</span></span> NewBalance <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TransType</span> Type <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> UpdateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">TransType</span>
<span class="token punctuation">&#123;</span>
    None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    Recharge <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    Purchase <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="system-implementation">System Implementation</h1>
<p>Here we implement each API and determine the required indexes and
shard keys based on actual read and write patterns. The APIs are
introduced step-by-step, starting with simpler ones and progressing to
more complex implementations.</p>
<h2 id="createaccount-api">CreateAccount API</h2>
<p>The <code>CreateAccount</code> API is straightforward. It does not
use transaction processing because the user's <code>Uuid</code> serves
as the primary key. If an account with the same <code>Uuid</code>
already exists, the insert operation will fail due to the unique
constraint.</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token function">CreateAccountAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> newAccount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AccountEntry</span>
        <span class="token punctuation">&#123;</span>
            Uuid <span class="token operator">=</span> uuid<span class="token punctuation">,</span>
            Balance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
            CreateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
            UpdateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">InsertOneAsync</span><span class="token punctuation">(</span>newAccount<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> newAccount<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="getbalance-api">GetBalance API</h2>
<p>The implementation of retrieving the balance is straightforward. Note
that the <code>IClientSessionHandle</code> parameter is optional. When
this parameter is provided, it serves as a basic building block of
complex transactions：</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">decimal</span><span class="token punctuation">></span></span> <span class="token function">GetBalanceAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name">IClientSessionHandle</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">AccountEntry</span> account<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        account <span class="token operator">=</span> <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid <span class="token operator">==</span> uuid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
        account <span class="token operator">=</span> <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid <span class="token operator">==</span> uuid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>account <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyNotFoundException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Account '</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">uuid</span><span class="token punctuation">&#125;</span></span><span class="token string">' does not exist."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> account<span class="token punctuation">.</span>Balance<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>This API requires <code>Account</code> index：(Uuid).</p>
<h2 id="addbalance-decreasebalance-api">AddBalance &amp; DecreaseBalance
API</h2>
<p>The operations on the balance are also the foundation for
constructing subsequent transaction APIs. The implementation of these
two APIs uses MongoDB's <code>Inc</code> operator for atomic operations,
and they also support transactions. They will not be used independently,
as both increasing or decreasing the balance require corresponding
transaction records. Therefore, the <code>IClientSessionHandle</code>
parameter is mandatory:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token function">AddBalanceAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name">IClientSessionHandle</span> s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">"Amount should > 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid<span class="token punctuation">,</span> accountId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Update
        <span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>UpdateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FindOneAndUpdateOptions<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> ReturnDocument <span class="token operator">=</span> ReturnDocument<span class="token punctuation">.</span>After<span class="token punctuation">,</span> IsUpsert <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">FindOneAndUpdateAsync</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token function">DecreaseBalanceAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name">IClientSessionHandle</span> s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">"Amount should > 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>
        Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid<span class="token punctuation">,</span> accountId<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Gte</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Update
        <span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span> <span class="token operator">-</span>amount<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>UpdateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FindOneAndUpdateOptions<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> ReturnDocument <span class="token operator">=</span> ReturnDocument<span class="token punctuation">.</span>After <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">FindOneAndUpdateAsync</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>It is worth mentioning that in our design, the amount in both of
these APIs is always a positive number. The advantage of this is that
when decreasing the balance, we can include
<code>Filter.Gte(x =&gt; x.Balance, amount)</code>, which further
ensures the correctness of the balance deduction.</p>
<p>These two APIs require an index on the <code>Account</code> table:
<code>(Uuid)</code>.</p>
<h2 id="gettransactionbytid-gettransactions-api">GetTransactionByTid
&amp; GetTransactions API</h2>
<p>Both APIs are simple:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TransEntry<span class="token punctuation">></span></span> <span class="token function">GetTransactionByTidAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> tid<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name">IClientSessionHandle</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Tid <span class="token operator">==</span> tid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span>Tid <span class="token operator">==</span> tid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TransEntry<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetTransactionsAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid <span class="token operator">==</span> accountId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SortBy</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>These two APIs require an index on the <code>Trans</code> table:
(Uuid, CreateTime), (Tid).</p>
<h2 id="recharge-api">Recharge API</h2>
<p>Here come the two most complex transaction APIs:
<code>Recharge</code> and <code>Purchase</code>. Note that these two
APIs not only ensure consistency, but also need to guarantee
idempotency, meaning they must support repeated calls without affecting
the final result.</p>
<p>For <code>Recharge</code>, three operations are involved, which
require a transaction:</p>
<ul>
<li><code>GetTransactionByTid</code>: The caller needs to pass in the
<code>Tid</code> to prevent duplicate transactions. Idempotency is
ensured by this step. In practical applications, the <code>Tid</code>
can be the unique identifier returned by a third-party financial
system.</li>
<li><code>AddBalance</code>: This API was implemented earlier.</li>
<li><code>InsertTransaction</code>: Adds a recharge transaction
record.</li>
</ul>
<p>If any of the above three operations fail, MongoDB's transaction can
be used to roll back the changes, ensuring strong consistency of the
transaction:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TransResult<span class="token punctuation">></span></span> <span class="token function">RechargeAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> tid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> session <span class="token operator">=</span> <span class="token keyword">await</span> _mongoClient<span class="token punctuation">.</span><span class="token function">StartSessionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">WithTransactionAsync</span><span class="token punctuation">(</span>
            <span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> ct<span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> existingTransEntry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetTransactionByTidAsync</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> ct<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTransEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span> <span class="token punctuation">&#123;</span> Code <span class="token operator">=</span> TransCode<span class="token punctuation">.</span>DuplicateTrans <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> newBalanceEntry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">AddBalanceAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> ct<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> newTransEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransEntry</span>
                <span class="token punctuation">&#123;</span>
                    Tid <span class="token operator">=</span> <span class="token function">GenerateTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Uuid <span class="token operator">=</span> accountId<span class="token punctuation">,</span>
                    Amount <span class="token operator">=</span> amount<span class="token punctuation">,</span>
                    NewBalance <span class="token operator">=</span> newBalanceEntry<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span>
                    Type <span class="token operator">=</span> TransType<span class="token punctuation">.</span>Recharge<span class="token punctuation">,</span>
                    CreateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
                    UpdateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">InsertOneAsync</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> newTransEntry<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span>
                <span class="token punctuation">&#123;</span>
                    NewBalance <span class="token operator">=</span> newTransEntry<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span>
                    Tid <span class="token operator">=</span> newTransEntry<span class="token punctuation">.</span>Tid
                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="purchase-api">Purchase API</h2>
<p>The implementation of the <code>Purchase</code> API is essentially
the same as <code>Recharge</code>, with <code>AddBalance</code> replaced
by <code>DecreaseBalance</code>.</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TransResult<span class="token punctuation">></span></span> <span class="token function">PurchaseAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> tid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> session <span class="token operator">=</span> <span class="token keyword">await</span> _mongoClient<span class="token punctuation">.</span><span class="token function">StartSessionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">WithTransactionAsync</span><span class="token punctuation">(</span>
            <span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> ct<span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> existingTransEntry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetTransactionByTidAsync</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> ct<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTransEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span> <span class="token punctuation">&#123;</span> Code <span class="token operator">=</span> TransCode<span class="token punctuation">.</span>DuplicateTrans <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> newBalanceEntry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">DecreaseBalanceAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> ct<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newBalanceEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span> <span class="token punctuation">&#123;</span> Code <span class="token operator">=</span> TransCode<span class="token punctuation">.</span>InsufficientBalance <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> newTransEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransEntry</span>
                <span class="token punctuation">&#123;</span>
                    Tid <span class="token operator">=</span> <span class="token function">GenerateTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Uuid <span class="token operator">=</span> accountId<span class="token punctuation">,</span>
                    Amount <span class="token operator">=</span> amount<span class="token punctuation">,</span>
                    NewBalance <span class="token operator">=</span> newBalanceEntry<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span>
                    Type <span class="token operator">=</span> TransType<span class="token punctuation">.</span>Purchase<span class="token punctuation">,</span>
                    CreateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
                    UpdateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">InsertOneAsync</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> newTransEntry<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span>
                <span class="token punctuation">&#123;</span>
                    NewBalance <span class="token operator">=</span> newTransEntry<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span>
                    Tid <span class="token operator">=</span> newTransEntry<span class="token punctuation">.</span>Tid
                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>In practice, the <code>Purchase</code> API can be modified to
incorperate business logic, ensuring consistency between the business
logic and the transaction system.</p>
<h2 id="indexes-and-shard-keys">Indexes and Shard Keys</h2>
<p>Based on the above implementations and considering the leftmost
prefix matching principle, we need one indexe on
<code>Account</code>:</p>
<ul>
<li>(Uuid)</li>
</ul>
<p>Two indexes on <code>Trans</code>：</p>
<ul>
<li>(Uuid, CreateTime)</li>
<li>(Tid)</li>
</ul>
<p>Both <code>Account</code> and <code>Trans</code> could use
<code>Uuid</code> as the sharding key.</p>
<h1 id="test-code">Test Code</h1>
<p>Create 10 accounts and perform an initial recharge of 1000 for each
account. Generate 5 transactions for each account, randomly deciding the
transaction type (recharge or purchase), with transaction amounts
between 0 and 300. Print the current balance of each account, as well as
the details of the last 10 transactions.</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create 10 accounts</span>
    <span class="token class-name"><span class="token keyword">var</span></span> accountIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> accountId <span class="token operator">=</span> <span class="token function">GenerateAccountUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> account <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">CreateAccountAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountIds<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>account<span class="token punctuation">.</span>Uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> <span class="token function">RechargeAsync</span><span class="token punctuation">(</span>account<span class="token punctuation">.</span>Uuid<span class="token punctuation">,</span> <span class="token function">GenerateTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Created account </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">account<span class="token punctuation">.</span>Uuid</span><span class="token punctuation">&#125;</span></span><span class="token string"> with initial balance of 1000."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> accountId <span class="token keyword">in</span> accountIds<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> isRecharge <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> amount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">decimal</span><span class="token punctuation">)</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">NextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> tid <span class="token operator">=</span> <span class="token function">GenerateTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>isRecharge<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">RechargeAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>Code <span class="token operator">==</span> TransCode<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Recharge: Account </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">accountId</span><span class="token punctuation">&#125;</span></span><span class="token string">, Amount: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, New Balance: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, Tid: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">tid</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">&#123;</span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Recharge failed: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">result<span class="token punctuation">.</span>Code</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">PurchaseAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>Code <span class="token operator">==</span> TransCode<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Purchase: Account </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">accountId</span><span class="token punctuation">&#125;</span></span><span class="token string">, Amount: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, New Balance: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, Tid: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">tid</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">&#123;</span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Purchase failed: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">result<span class="token punctuation">.</span>Code</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> accountId <span class="token keyword">in</span> accountIds<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetBalanceAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> CancellationToken<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> transactions <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetTransactionsAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> CancellationToken<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Account </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">accountId</span><span class="token punctuation">&#125;</span></span><span class="token string"> Balance: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>balance<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Recent Transactions:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> transaction <span class="token keyword">in</span> transactions<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Tid: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">transaction<span class="token punctuation">.</span>Tid</span><span class="token punctuation">&#125;</span></span><span class="token string">, Type: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">transaction<span class="token punctuation">.</span>Type</span><span class="token punctuation">&#125;</span></span><span class="token string">, Amount: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, New Balance: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, Time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">transaction<span class="token punctuation">.</span>CreateTime</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"****************************************************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Some results:</p>
<blockquote>
<p>Account Acc_BE2E2B2FD3A2490CBEEA9625C3BD7C18 Balance: 1267.83 Recent
Transactions: Tid: T_6DA267BECAC945E2973903C7EE36C599, Type: Recharge,
Amount: 1000, New Balance: 1000, Time: 11/24/2024 4:00:42 AM Tid:
T_6BB3C3B2E9CD4197B609957C2937D218, Type: Purchase, Amount: 42.27, New
Balance: 957.73, Time: 11/24/2024 4:00:43 AM Tid:
T_0D63FB52BCBF4FF382D7C611252329F4, Type: Recharge, Amount: 156.83, New
Balance: 1114.56, Time: 11/24/2024 4:00:43 AM Tid:
T_30201F58B3AA4BD6B14C4B9DC0A20272, Type: Recharge, Amount: 78.78, New
Balance: 1193.33, Time: 11/24/2024 4:00:43 AM Tid:
T_42837124561748BFBECA1677FD951338, Type: Purchase, Amount: 153.88, New
Balance: 1039.46, Time: 11/24/2024 4:00:43 AM Tid:
T_16DC47F772814D4A8A3E1DBCF26B661D, Type: Recharge, Amount: 228.38, New
Balance: 1267.83, Time: 11/24/2024 4:00:43 AM</p>
</blockquote>
<p>Connect to the database deployed on MongoDB Atlas using MongoDB
Compass:</p>
<p><img
src="https://coriva.eu.org/images/mongodb/transentries.png" /></p>
<p>In this post, we provide complete account management and transaction
support functions based on MongoDB, making it suitable for small to
medium-sized transaction systems. It is also easily extendable to more
complex application scenarios, such as multi-currency support and
international payments. Each functional module works together through
transactions, filters, and idempotency handling to build a secure,
efficient, and scalable transaction system framework.</p>
<p>This design meets the practical business needs of high concurrency,
data consistency, and complex transactions, while also providing clear
error handling pathways for easier maintenance and expansion.</p>
<h1 id="full-demo">Full Demo</h1>
<p>Fill the <code>ConnectionString</code>:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">MongoDB<span class="token punctuation">.</span>Bson<span class="token punctuation">.</span>Serialization<span class="token punctuation">.</span>Conventions</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">MongoDB<span class="token punctuation">.</span>Driver</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">MongoTest</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            model<span class="token punctuation">.</span><span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>


    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountEntry</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Uuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">decimal</span></span> Balance <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> UpdateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransEntry</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Tid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Uuid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">decimal</span></span> Amount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">decimal</span></span> NewBalance <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">TransType</span> Type <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> UpdateTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">TransType</span>
    <span class="token punctuation">&#123;</span>
        None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        Recharge <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        Purchase <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransResult</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Tid <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">decimal</span></span> NewBalance <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">TransCode</span> Code <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">TransCode</span>
    <span class="token punctuation">&#123;</span>
        Success <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        DuplicateTrans <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        Purchase <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
        InsufficientBalance <span class="token operator">=</span> <span class="token number">3</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransModel</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMongoClient</span> _mongoClient<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMongoCollection<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> _accountCollection<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMongoCollection<span class="token punctuation">&lt;</span>TransEntry<span class="token punctuation">></span></span> _transCollection<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> DatabaseName <span class="token operator">=</span> <span class="token string">"Transaction"</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> AccountCollectionName <span class="token operator">=</span> <span class="token string">"Account"</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> TransCollectionName <span class="token operator">=</span> <span class="token string">"Trans"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> ConnectionString <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">TransModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _mongoClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MongoClient</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> database <span class="token operator">=</span> _mongoClient<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span>DatabaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> ignoreExtraElementsConvention <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConventionPack</span> <span class="token punctuation">&#123;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IgnoreExtraElementsConvention</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            ConventionRegistry<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">"IgnoreExtraElements"</span><span class="token punctuation">,</span> ignoreExtraElementsConvention<span class="token punctuation">,</span> type <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _accountCollection <span class="token operator">=</span> database<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCollection</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>AccountCollectionName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _transCollection <span class="token operator">=</span> database<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCollection</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TransEntry<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>TransCollectionName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GenerateTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token interpolation-string"><span class="token string">$"T_</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GenerateAccountUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token interpolation-string"><span class="token string">$"Acc_</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token function">CreateAccountAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> newAccount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AccountEntry</span>
                <span class="token punctuation">&#123;</span>
                    Uuid <span class="token operator">=</span> uuid<span class="token punctuation">,</span>
                    Balance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    CreateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
                    UpdateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow
                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">InsertOneAsync</span><span class="token punctuation">(</span>newAccount<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> newAccount<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">decimal</span><span class="token punctuation">></span></span> <span class="token function">GetBalanceAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> uuid<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name">IClientSessionHandle</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name">AccountEntry</span> account<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                account <span class="token operator">=</span> <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid <span class="token operator">==</span> uuid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                account <span class="token operator">=</span> <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid <span class="token operator">==</span> uuid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>account <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyNotFoundException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Account '</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">uuid</span><span class="token punctuation">&#125;</span></span><span class="token string">' does not exist."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">return</span> account<span class="token punctuation">.</span>Balance<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token function">AddBalanceAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name">IClientSessionHandle</span> s<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">"Amount should > 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid<span class="token punctuation">,</span> accountId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Update
                <span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>UpdateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FindOneAndUpdateOptions<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> ReturnDocument <span class="token operator">=</span> ReturnDocument<span class="token punctuation">.</span>After<span class="token punctuation">,</span> IsUpsert <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">FindOneAndUpdateAsync</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token function">DecreaseBalanceAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name">IClientSessionHandle</span> s<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">"Amount should > 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>
                Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid<span class="token punctuation">,</span> accountId<span class="token punctuation">)</span><span class="token punctuation">,</span>
                Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Gte</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>AccountEntry<span class="token operator">></span><span class="token punctuation">.</span>Update
                <span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span> <span class="token operator">-</span>amount<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>UpdateTime<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FindOneAndUpdateOptions<span class="token punctuation">&lt;</span>AccountEntry<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> ReturnDocument <span class="token operator">=</span> ReturnDocument<span class="token punctuation">.</span>After <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> _accountCollection<span class="token punctuation">.</span><span class="token function">FindOneAndUpdateAsync</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TransEntry<span class="token punctuation">></span></span> <span class="token function">GetTransactionByTidAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> tid<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name">IClientSessionHandle</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Tid <span class="token operator">==</span> tid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span>Tid <span class="token operator">==</span> tid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>TransEntry<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetTransactionsAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Uuid <span class="token operator">==</span> accountId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SortBy</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>CreateTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TransResult<span class="token punctuation">></span></span> <span class="token function">RechargeAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> tid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> session <span class="token operator">=</span> <span class="token keyword">await</span> _mongoClient<span class="token punctuation">.</span><span class="token function">StartSessionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">WithTransactionAsync</span><span class="token punctuation">(</span>
                    <span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> ct<span class="token punctuation">)</span> <span class="token operator">=></span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token class-name"><span class="token keyword">var</span></span> existingTransEntry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetTransactionByTidAsync</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> ct<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTransEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token punctuation">&#123;</span>
                            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span> <span class="token punctuation">&#123;</span> Code <span class="token operator">=</span> TransCode<span class="token punctuation">.</span>DuplicateTrans <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>

                        <span class="token class-name"><span class="token keyword">var</span></span> newBalanceEntry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">AddBalanceAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> ct<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token class-name"><span class="token keyword">var</span></span> newTransEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransEntry</span>
                        <span class="token punctuation">&#123;</span>
                            Tid <span class="token operator">=</span> <span class="token function">GenerateTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            Uuid <span class="token operator">=</span> accountId<span class="token punctuation">,</span>
                            Amount <span class="token operator">=</span> amount<span class="token punctuation">,</span>
                            NewBalance <span class="token operator">=</span> newBalanceEntry<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span>
                            Type <span class="token operator">=</span> TransType<span class="token punctuation">.</span>Recharge<span class="token punctuation">,</span>
                            CreateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
                            UpdateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

                        <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">InsertOneAsync</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> newTransEntry<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span>
                        <span class="token punctuation">&#123;</span>
                            NewBalance <span class="token operator">=</span> newTransEntry<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span>
                            Tid <span class="token operator">=</span> newTransEntry<span class="token punctuation">.</span>Tid
                        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TransResult<span class="token punctuation">></span></span> <span class="token function">PurchaseAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> accountId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> tid<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> session <span class="token operator">=</span> <span class="token keyword">await</span> _mongoClient<span class="token punctuation">.</span><span class="token function">StartSessionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">WithTransactionAsync</span><span class="token punctuation">(</span>
                    <span class="token keyword">async</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> ct<span class="token punctuation">)</span> <span class="token operator">=></span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token class-name"><span class="token keyword">var</span></span> existingTransEntry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetTransactionByTidAsync</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> ct<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingTransEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token punctuation">&#123;</span>
                            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span> <span class="token punctuation">&#123;</span> Code <span class="token operator">=</span> TransCode<span class="token punctuation">.</span>DuplicateTrans <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>

                        <span class="token class-name"><span class="token keyword">var</span></span> newBalanceEntry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">DecreaseBalanceAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> ct<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>newBalanceEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token punctuation">&#123;</span>
                            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span> <span class="token punctuation">&#123;</span> Code <span class="token operator">=</span> TransCode<span class="token punctuation">.</span>InsufficientBalance <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>

                        <span class="token class-name"><span class="token keyword">var</span></span> newTransEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransEntry</span>
                        <span class="token punctuation">&#123;</span>
                            Tid <span class="token operator">=</span> <span class="token function">GenerateTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            Uuid <span class="token operator">=</span> accountId<span class="token punctuation">,</span>
                            Amount <span class="token operator">=</span> amount<span class="token punctuation">,</span>
                            NewBalance <span class="token operator">=</span> newBalanceEntry<span class="token punctuation">.</span>Balance<span class="token punctuation">,</span>
                            Type <span class="token operator">=</span> TransType<span class="token punctuation">.</span>Purchase<span class="token punctuation">,</span>
                            CreateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
                            UpdateTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

                        <span class="token keyword">await</span> _transCollection<span class="token punctuation">.</span><span class="token function">InsertOneAsync</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> newTransEntry<span class="token punctuation">,</span> <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> ct<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransResult</span>
                        <span class="token punctuation">&#123;</span>
                            NewBalance <span class="token operator">=</span> newTransEntry<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span>
                            Tid <span class="token operator">=</span> newTransEntry<span class="token punctuation">.</span>Tid
                        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    <span class="token named-parameter punctuation">cancellationToken</span><span class="token punctuation">:</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Create 10 accounts</span>
            <span class="token class-name"><span class="token keyword">var</span></span> accountIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> accountId <span class="token operator">=</span> <span class="token function">GenerateAccountUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> account <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">CreateAccountAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                accountIds<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>account<span class="token punctuation">.</span>Uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> <span class="token function">RechargeAsync</span><span class="token punctuation">(</span>account<span class="token punctuation">.</span>Uuid<span class="token punctuation">,</span> <span class="token function">GenerateTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Created account </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">account<span class="token punctuation">.</span>Uuid</span><span class="token punctuation">&#125;</span></span><span class="token string"> with initial balance of 1000."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> accountId <span class="token keyword">in</span> accountIds<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> isRecharge <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> amount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">decimal</span><span class="token punctuation">)</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">NextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> tid <span class="token operator">=</span> <span class="token function">GenerateTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRecharge<span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">RechargeAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>Code <span class="token operator">==</span> TransCode<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>
                        <span class="token punctuation">&#123;</span>
                            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Recharge: Account </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">accountId</span><span class="token punctuation">&#125;</span></span><span class="token string">, Amount: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, New Balance: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, Tid: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">tid</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">else</span>
                        <span class="token punctuation">&#123;</span>
                            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Recharge failed: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">result<span class="token punctuation">.</span>Code</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">PurchaseAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>Code <span class="token operator">==</span> TransCode<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>
                        <span class="token punctuation">&#123;</span>
                            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Purchase: Account </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">accountId</span><span class="token punctuation">&#125;</span></span><span class="token string">, Amount: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, New Balance: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, Tid: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">tid</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">else</span>
                        <span class="token punctuation">&#123;</span>
                            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Purchase failed: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">result<span class="token punctuation">.</span>Code</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> accountId <span class="token keyword">in</span> accountIds<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetBalanceAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> CancellationToken<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> transactions <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetTransactionsAsync</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> CancellationToken<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>

                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Account </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">accountId</span><span class="token punctuation">&#125;</span></span><span class="token string"> Balance: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>balance<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Recent Transactions:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> transaction <span class="token keyword">in</span> transactions<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Tid: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">transaction<span class="token punctuation">.</span>Tid</span><span class="token punctuation">&#125;</span></span><span class="token string">, Type: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">transaction<span class="token punctuation">.</span>Type</span><span class="token punctuation">&#125;</span></span><span class="token string">, Amount: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span>Amount<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, New Balance: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">Math<span class="token punctuation">.</span><span class="token function">Round</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span>NewBalance<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span><span class="token string">, Time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">transaction<span class="token punctuation">.</span>CreateTime</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"****************************************************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C#</a>
              <a href="/tags/MongoDB/" rel="tag"># MongoDB</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/building-a-transaction-system-with-mongodb/" rel="prev" title="用MongoDB构建交易系统">
                  <i class="fa fa-chevron-left"></i> 用MongoDB构建交易系统
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/en/use-az-cli-to-query-vm-cpu-credits/" rel="next" title="Use az cli to Query VM Remaining CPU Credits">
                  Use az cli to Query VM Remaining CPU Credits <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">finisky</span>
</div><div><span class="post-meta-item-icon"><i class="far fa-eye"></i></span><span><a href="https://finicounter.eu.org/" target="_blank">Total Views</a>:</span><span id="finicount_views" style="display:inline;padding-left:5px;"></span><div> <script async src="//finicounter.eu.org/finicounter.js"></script>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/finisky" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  




  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"en","enable":true,"serverURL":"https://comments.finisky.eu.org","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":true,"pageSize":10,"el":"#waline","comment":true,"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","path":"/en/building-a-transaction-system-with-mongodb/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>


        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body>
</html>
